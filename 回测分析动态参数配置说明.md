# 回测分析动态参数配置说明

## 改进概述

将回测分析界面的参数设置从写死的硬编码方式改为动态配置，让用户可以根据不同策略自动加载和配置参数。

## 主要改进内容

### 1. 动态参数加载
- **原来**：参数写死在代码中，不同策略需要修改代码
- **现在**：从数据库的`strategy_parameter_spaces`表动态加载参数配置

### 2. 策略选择联动
- 当用户选择不同策略时，自动加载该策略的参数空间
- 根据参数类型（int/float/choice）自动生成对应的输入控件
- 自动设置参数的默认值（使用最小值）

### 3. 参数界面优化
- 支持多种参数类型：整数、浮点数、选择项
- 自动显示参数范围、步长、描述信息
- 动态调整模态框宽度以适应更多参数

## 技术实现

### 1. 新增状态管理
```typescript
const [parameterSpaces, setParameterSpaces] = useState<any[]>([]);
const [currentStrategyInfo, setCurrentStrategyInfo] = useState<any>(null);
```

### 2. 参数空间加载函数
```typescript
const loadParameterSpaces = async (strategyId: number) => {
  try {
    const response = await axios.get(`/api/optimization/strategies/${strategyId}/parameter-spaces`);
    if (response.data && response.data.status === 'success') {
      setParameterSpaces(response.data.data);
      
      // 根据参数空间初始化默认参数值
      const defaultParams: Record<string, any> = {};
      response.data.data.forEach((param: any) => {
        if (param.parameter_type === 'int' || param.parameter_type === 'float') {
          defaultParams[param.parameter_name] = param.min_value;
        }
      });
      setStrategyParameters(defaultParams);
    }
  } catch (error) {
    console.error('加载参数空间失败:', error);
    setParameterSpaces([]);
    setStrategyParameters({});
  }
};
```

### 3. 策略选择处理
```typescript
const handleStrategyChange = (strategyId: number) => {
  setSelectedStrategy(strategyId);
  
  // 更新策略名称
  const strategy = strategiesList.find(s => s.id === strategyId);
  if (strategy) {
    setSelectedStrategyName(strategy.name);
    setCurrentStrategyInfo(strategy);
  }
  
  // 加载参数空间
  loadParameterSpaces(strategyId);
};
```

### 4. 动态参数渲染
```typescript
{parameterSpaces.map((param, index) => (
  <Col span={12} key={param.parameter_name}>
    <Form.Item 
      label={`${param.parameter_name}${param.description ? ` (${param.description})` : ''}`}
      help={param.description}
    >
      {param.parameter_type === 'int' ? (
        <InputNumber
          value={strategyParameters[param.parameter_name] || param.min_value}
          onChange={(value) => setStrategyParameters(prev => ({ 
            ...prev, 
            [param.parameter_name]: value 
          }))}
          min={param.min_value}
          max={param.max_value}
          step={param.step_size}
          style={{ width: '100%' }}
        />
      ) : param.parameter_type === 'float' ? (
        <InputNumber
          value={strategyParameters[param.parameter_name] || param.min_value}
          onChange={(value) => setStrategyParameters(prev => ({ 
            ...prev, 
            [param.parameter_name]: value 
          }))}
          min={param.min_value}
          max={param.max_value}
          step={param.step_size}
          precision={2}
          style={{ width: '100%' }}
        />
      ) : (
        <Input
          value={strategyParameters[param.parameter_name] || ''}
          onChange={(e) => setStrategyParameters(prev => ({ 
            ...prev, 
            [param.parameter_name]: e.target.value 
          }))}
          placeholder={`请输入${param.parameter_name}`}
        />
      )}
    </Form.Item>
  </Col>
))}
```

## 功能特性

### 1. 自动参数初始化
- 根据参数空间自动设置默认值
- 支持整数、浮点数、字符串等不同类型
- 自动应用参数范围限制

### 2. 智能界面适配
- 根据参数数量动态调整布局
- 自动显示参数说明和范围信息
- 支持参数验证和错误提示

### 3. 参数管理功能
- **重置默认值**：一键恢复所有参数为默认值
- **从优化导入**：从参数优化结果导入最佳参数（待实现）
- **参数说明**：显示每个参数的详细说明和取值范围

### 4. 错误处理
- 当策略没有配置参数空间时，显示友好提示
- 网络错误时自动降级到默认参数
- 参数加载失败时不影响回测功能

## 使用流程

### 1. 选择策略
- 在策略选择下拉框中选择要回测的策略
- 系统自动加载该策略的参数配置

### 2. 配置参数
- 点击"参数"按钮打开参数设置模态框
- 根据参数说明调整各项参数值
- 系统自动验证参数范围

### 3. 执行回测
- 参数配置完成后点击"开始回测"
- 系统使用配置的参数执行回测
- 回测结果中包含使用的参数信息

## 支持的策略类型

### 1. MA交叉策略
- `short_window`: 短期均线周期 (3-15天)
- `long_window`: 长期均线周期 (10-60天)

### 2. 极大极小值策略
- `min_reversal_points`: 确认极值需要的最少连续反转点数 (3-8)
- `lookback_period`: 寻找极值的回望周期 (8-15)
- `min_price_change`: 最小价格变化幅度 (0.03-0.08)
- `signal_strength_threshold`: 信号强度阈值 (0.4-0.8)
- `max_trading_range`: 限制在极值点附近的最大交易范围 (2-5天)
- `batch_count`: 分批建仓的批次数 (3-6)
- `batch_interval`: 分批建仓的间隔天数 (2-5)
- `position_size_per_batch`: 每批建仓的仓位比例 (0.2-0.4)
- `stop_loss_ratio`: 止损比例 (0.05-0.15)
- `take_profit_ratio`: 止盈比例 (0.15-0.3)
- `rsi_oversold`: RSI超卖阈值 (25-35)
- `rsi_overbought`: RSI超买阈值 (65-75)
- `volume_threshold`: 成交量放大阈值 (1.2-2.0)
- `max_extremums`: 最大极值点数量限制 (30-80)
- `min_extremum_distance`: 极值点之间的最小距离 (3-8)

## 扩展性

### 1. 新增策略支持
- 只需在数据库中配置参数空间
- 无需修改前端代码
- 自动支持新的参数类型

### 2. 参数类型扩展
- 支持整数、浮点数、选择项
- 可扩展支持布尔值、日期等类型
- 支持自定义验证规则

### 3. 界面优化
- 可根据参数数量自动调整布局
- 支持参数分组和折叠
- 支持参数模板和预设

## 总结

通过这次改进，回测分析界面实现了：

✅ **动态参数配置**：根据策略自动加载参数
✅ **用户友好界面**：直观的参数设置和说明
✅ **扩展性强**：支持新策略和参数类型
✅ **错误处理完善**：优雅处理各种异常情况
✅ **与优化集成**：复用参数优化配置

现在用户可以为任何策略轻松配置参数，无需修改代码，大大提升了系统的易用性和扩展性。
