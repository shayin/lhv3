# 策略开发规则

## 🚨 核心原则：严禁使用未来数据

### 1. 基本原则
- **绝对禁止**：在生成交易信号时使用未来数据
- **回测逻辑**：每个时间点只能使用该时间点及之前的数据
- **现实模拟**：策略必须模拟真实交易环境

### 2. 常见违规行为 ❌

#### 2.1 使用整个数据集的极值
```python
# ❌ 错误示例
max_price = data['close'].max()  # 使用了未来数据
min_price = data['close'].min()  # 使用了未来数据

# ✅ 正确做法
rolling_max = data['close'].rolling(window=20).max()  # 使用滚动窗口
```

#### 2.2 使用未来价格进行决策
```python
# ❌ 错误示例
if current_price == data['close'].max():  # 使用了未来数据
    sell_signal = True

# ✅ 正确做法
if current_price >= rolling_max * 0.95:  # 使用历史滚动最大值
    sell_signal = True
```

#### 2.3 基于未来数据计算指标
```python
# ❌ 错误示例
future_ma = data['close'].shift(-5).rolling(20).mean()  # 使用了未来数据

# ✅ 正确做法
past_ma = data['close'].rolling(20).mean()  # 只使用历史数据
```

### 3. 正确的策略开发模式 ✅

#### 3.1 滚动窗口方法
```python
def generate_signals(self):
    # 使用滚动窗口计算指标
    signals['ma_20'] = signals['close'].rolling(window=20).mean()
    signals['ma_50'] = signals['close'].rolling(window=50).mean()
    
    # 逐日生成信号
    for i in range(len(signals)):
        # 只能使用当前及之前的数据
        current_data = signals.iloc[:i+1]
        # 生成信号逻辑...
```

#### 3.2 状态机方法
```python
def generate_signals(self):
    position = 0  # 当前持仓状态
    buy_price = 0  # 买入价格
    
    for i in range(len(signals)):
        current_price = signals.iloc[i]['close']
        
        # 基于当前状态和历史数据做决策
        if position == 0 and self.should_buy(current_price, signals.iloc[:i+1]):
            signals.iloc[i, 'signal'] = 1
            position = 1
        elif position == 1 and self.should_sell(current_price, signals.iloc[:i+1]):
            signals.iloc[i, 'signal'] = -1
            position = 0
```

### 4. 策略验证检查清单

#### 4.1 数据使用检查
- [ ] 是否使用了 `data['close'].max()` 等全量数据？
- [ ] 是否使用了 `data['close'].shift(-n)` 等未来数据？
- [ ] 是否在循环中使用了完整数据集？

#### 4.2 逻辑验证
- [ ] 策略是否逐日生成信号？
- [ ] 每个时间点是否只使用历史数据？
- [ ] 交易记录是否在扩展数据后保持不变？

#### 4.3 测试方法
```python
# 测试策略是否使用未来数据
def test_no_future_data():
    # 创建测试数据
    data1 = create_test_data('2023-01-01', '2023-02-01')
    data2 = create_test_data('2023-01-01', '2023-03-01')
    
    # 运行策略
    result1 = strategy.run(data1)
    result2 = strategy.run(data2)
    
    # 验证：1月1日-2月1日的交易记录应该相同
    assert result1['trades'] == result2['trades'][:len(result1['trades'])]
```

### 5. 策略模板

#### 5.1 基础策略模板
```python
class MyStrategy(StrategyBase):
    def generate_signals(self):
        signals = self.data.copy()
        signals['signal'] = 0
        
        # 计算技术指标（只使用历史数据）
        signals['ma_short'] = signals['close'].rolling(5).mean()
        signals['ma_long'] = signals['close'].rolling(20).mean()
        
        # 逐日生成信号
        for i in range(1, len(signals)):  # 从第2天开始
            current = signals.iloc[i]
            previous = signals.iloc[i-1]
            
            # 买入信号：短期均线上穿长期均线
            if (current['ma_short'] > current['ma_long'] and 
                previous['ma_short'] <= previous['ma_long']):
                signals.iloc[i, 'signal'] = 1
                
            # 卖出信号：短期均线下穿长期均线
            elif (current['ma_short'] < current['ma_long'] and 
                  previous['ma_short'] >= previous['ma_long']):
                signals.iloc[i, 'signal'] = -1
        
        return signals
```

### 6. 违规处罚

#### 6.1 代码审查
- 所有新策略必须通过代码审查
- 重点检查是否使用未来数据
- 必须提供测试用例证明策略正确性

#### 6.2 测试要求
- 策略必须通过"数据扩展测试"
- 交易记录在数据扩展后必须保持一致
- 收益率必须合理，不能异常高

### 7. 最佳实践

#### 7.1 开发流程
1. **设计阶段**：明确策略逻辑，确保不使用未来数据
2. **编码阶段**：严格按照模板开发，逐日生成信号
3. **测试阶段**：进行数据扩展测试，验证一致性
4. **审查阶段**：代码审查，确保合规

#### 7.2 调试技巧
```python
# 添加调试日志
def generate_signals(self):
    for i in range(len(signals)):
        current_date = signals.index[i]
        logger.info(f"处理日期: {current_date}, 可用数据: {i+1}天")
        
        # 只能使用当前及之前的数据
        available_data = signals.iloc[:i+1]
        # 生成信号...
```

### 8. 常见问题解答

#### Q1: 如何计算移动平均线？
A: 使用 `rolling()` 方法，确保只使用历史数据：
```python
signals['ma'] = signals['close'].rolling(window=20).mean()
```

#### Q2: 如何避免使用未来数据？
A: 始终使用滚动窗口或逐日计算，不要使用全量数据：
```python
# ❌ 错误
max_price = data['close'].max()

# ✅ 正确
rolling_max = data['close'].rolling(20).max()
```

#### Q3: 如何测试策略正确性？
A: 使用数据扩展测试，验证交易记录一致性。

---

## 📋 策略开发检查清单

### 开发前
- [ ] 明确策略逻辑，不使用未来数据
- [ ] 设计合理的参数范围
- [ ] 准备测试数据

### 开发中
- [ ] 使用滚动窗口计算指标
- [ ] 逐日生成信号
- [ ] 添加详细日志
- [ ] 进行单元测试

### 开发后
- [ ] 数据扩展测试
- [ ] 性能指标检查
- [ ] 代码审查
- [ ] 文档完善

---

**记住：回测的目的是验证策略在真实环境中的表现，使用未来数据会完全破坏这个目的！**