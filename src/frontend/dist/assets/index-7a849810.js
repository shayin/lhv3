import{k as e,L as $t,r as o,u as St,l as Es,E as qs,m as ka,n as Vs,B as $a,o as Da,p as at,N as za,q as Ca,R as Ia}from"./react-vendor-051c8ea5.js";import{L as dt,M as Dt,B as M,G as Ma,z as zt,C as Aa,D as Ks,F as Hs,H as es,I as Kt,J as Pt,K as Ct,R as pe,N as b,O as ce,P as de,Q as La,T as Pa,U as Na,V as Ta,W as Xe,X as xt,Y as K,Z as Ws,$ as B,a0 as $e,a1 as H,a2 as be,a3 as Us,a4 as Nt,a5 as ke,a6 as Fa,a7 as Rt,a8 as m,a9 as Be,aa as Oa,ab as Ya,ac as Ra,ad as Tt,ae as Ba,af as ts,ag as Gs,ah as ss,ai as as,aj as rs,ak as ns,al as os,am as ls,an as Ea,ao as qa,ap as Va,aq as is,ar as Ka,as as cs,at as et,au as Bt,av as ft,aw as We,ax as Ha,ay as me,az as Ie,aA as Et,aB as qt,aC as Zs,aD as Js,aE as ds,aF as Qs,aG as mt,aH as Wa,aI as us,aJ as Ua,aK as js,aL as Ga,aM as Za,aN as Xs,aO as Ja,aP as Re,aQ as bs,aR as ea,aS as ta,aT as Qa}from"./vendor-5df081ed.js";import{M as Xa}from"./monaco-051d7ef0.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))f(u);new MutationObserver(u=>{for(const x of u)if(x.type==="childList")for(const w of x.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&f(w)}).observe(document,{childList:!0,subtree:!0});function n(u){const x={};return u.integrity&&(x.integrity=u.integrity),u.referrerPolicy&&(x.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?x.credentials="include":u.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function f(u){if(u.ep)return;u.ep=!0;const x=n(u);fetch(u.href,x)}})();const sa={token:{colorPrimary:"#1890ff",borderRadius:8,colorBgContainer:"#ffffff",fontSize:12,fontSizeSM:11,fontSizeLG:14,fontSizeXL:16},components:{Table:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Card:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Button:{borderRadius:6,fontSize:12},Typography:{fontSize:12},Form:{fontSize:12},Input:{fontSize:12},Select:{fontSize:12},Menu:{fontSize:12}}},{Header:er}=zt,{useToken:tr}=Aa,sr=()=>{const{token:r}=tr(),a=[{key:"/",icon:e.jsx(Ks,{}),label:e.jsx($t,{to:"/",children:"首页"})},{key:"/data",icon:e.jsx(Hs,{}),label:e.jsx($t,{to:"/data",children:"数据管理"})},{key:"/strategy",icon:e.jsx(es,{}),label:e.jsx($t,{to:"/strategy",children:"策略编辑"})},{key:"/backtest",icon:e.jsx(dt,{}),label:e.jsx($t,{to:"/backtest",children:"回测分析"})},{key:"/optimization",icon:e.jsx(Kt,{}),label:e.jsx($t,{to:"/optimization",children:"参数优化"})}];return e.jsxs(er,{style:{background:r.colorBgContainer,padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx("div",{className:"header-nav-logo",children:e.jsxs($t,{to:"/",style:{color:r.colorPrimary,fontSize:"18px",fontWeight:"bold",display:"flex",alignItems:"center"},children:[e.jsx(dt,{style:{marginRight:"8px",fontSize:"24px"}}),"量化交易系统"]})}),e.jsx(Dt,{className:"header-nav-menu",mode:"horizontal",selectedKeys:[window.location.pathname],style:{flex:1,marginLeft:"40px",borderBottom:"none"},items:a}),e.jsx("div",{children:e.jsx(M,{icon:e.jsx(Ma,{}),type:"text",href:"https://github.com/yourusername/quant-trading-system",target:"_blank",rel:"noopener noreferrer",children:"GitHub"})})]})},{Sider:ar}=zt,rr=()=>{const[r,a]=o.useState(!1),n=St(),f=Es(),u=[{key:"/",icon:e.jsx(Ks,{}),label:"首页"},{key:"/data",icon:e.jsx(Hs,{}),label:"数据管理"},{key:"/strategy",icon:e.jsx(es,{}),label:"策略编辑"},{key:"backtest",icon:e.jsx(dt,{}),label:"回测管理",children:[{key:"/backtest",icon:e.jsx(dt,{}),label:"回测分析"},{key:"/backtest/history",icon:e.jsx(Pt,{}),label:"回测历史"}]},{key:"/optimization",icon:e.jsx(Kt,{}),label:"参数优化"}],x=w=>{n(w.key)};return e.jsxs(ar,{collapsible:!0,collapsed:r,onCollapse:w=>a(w),style:{background:"#fff"},width:200,children:[e.jsx("div",{className:"logo",style:{visibility:r?"hidden":"visible"},children:"量化交易系统"}),e.jsx(Dt,{theme:"light",mode:"inline",selectedKeys:[f.pathname],items:u,onClick:x})]})};var nr=Object.defineProperty,or=Object.defineProperties,lr=Object.getOwnPropertyDescriptors,vs=Object.getOwnPropertySymbols,ir=Object.prototype.hasOwnProperty,cr=Object.prototype.propertyIsEnumerable,_s=(r,a,n)=>a in r?nr(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,ws=(r,a)=>{for(var n in a||(a={}))ir.call(a,n)&&_s(r,n,a[n]);if(vs)for(var n of vs(a))cr.call(a,n)&&_s(r,n,a[n]);return r},dr=(r,a)=>or(r,lr(a));const _t=o.memo(({option:r,loading:a=!1,height:n=400,lazyLoad:f=!0,threshold:u=.1,style:x,onChartReady:w,data:$,symbol:h,className:v,notMerge:F=!1,opts:J={renderer:"canvas"},onEvents:y})=>{const[he,ve]=o.useState(!f),[re,W]=o.useState(null),ne=o.useRef(null),g=o.useRef(null),E=o.useMemo(()=>(U,Ce)=>{const Ye=[];for(let q=0,Le=Ce.length;q<Le;q++){if(q<U-1){Ye.push("-");continue}let X=0;for(let Me=0;Me<U;Me++)X+=Ce[q-Me].close;Ye.push((X/U).toFixed(2))}return Ye},[]),C=o.useMemo(()=>!$||$.length===0?{}:{backgroundColor:"#fff",title:{text:h,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:$.map(U=>U.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:$.map(U=>U.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:$.map(U=>[U.open,U.close,U.low,U.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:E(5,$),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:E(10,$),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:$.map((U,Ce)=>[Ce,U.volume,U.close>U.open?1:-1])}]},[$,h,E]),Se=o.useMemo(()=>{const U=r||C;return!U||Object.keys(U).length===0?{}:dr(ws({},U),{animation:!1,progressive:1e3,progressiveThreshold:3e3,useUTC:!0})},[r,C]);o.useEffect(()=>{if(!f||he)return;const U=ne.current;if(U)return g.current=new IntersectionObserver(Ce=>{var Ye;const[q]=Ce;q.isIntersecting&&(ve(!0),(Ye=g.current)==null||Ye.disconnect())},{threshold:u}),g.current.observe(U),()=>{var Ce;(Ce=g.current)==null||Ce.disconnect()}},[f,he,u]);const xe=U=>{W(U),w==null||w(U)};return f&&!he?e.jsx("div",{ref:ne,style:ws({height:n,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fafafa",border:"1px dashed #d9d9d9"},x),children:e.jsxs("div",{style:{textAlign:"center",color:"#999"},children:[e.jsx("div",{children:"图表懒加载中..."}),e.jsx("div",{style:{fontSize:"12px",marginTop:"4px"},children:"滚动到此处将自动加载"})]})}):e.jsx("div",{ref:ne,style:x,children:e.jsx(Ct,{spinning:a,tip:"图表加载中...",children:e.jsx(qs,{className:v,option:Se,style:{height:n},onChartReady:xe,notMerge:F,opts:J,onEvents:y})})})});_t.displayName="OptimizedChart";const{Title:ur,Paragraph:pr}=xt,hr=o.memo(()=>{const r=o.useMemo(()=>[{name:"上证指数",value:3536.24,change:.84,color:"#f5222d"},{name:"深证成指",value:14672.16,change:1.26,color:"#f5222d"},{name:"创业板指",value:3213.84,change:1.78,color:"#f5222d"},{name:"恒生指数",value:26386.25,change:-.13,color:"#52c41a"}],[]),a=o.useMemo(()=>[{id:1,name:"移动平均交叉策略",symbol:"AAPL",return:12.5,date:"2023-09-15"},{id:2,name:"RSI策略",symbol:"MSFT",return:8.3,date:"2023-09-14"},{id:3,name:"MACD策略",symbol:"GOOGL",return:-2.1,date:"2023-09-13"},{id:4,name:"布林带策略",symbol:"AMZN",return:5.7,date:"2023-09-12"}],[]),n=o.useMemo(()=>({title:{text:"策略绩效比较",left:"center"},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{data:["移动平均交叉","RSI策略","MACD策略","布林带策略","沪深300"],bottom:10},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:["1月","2月","3月","4月","5月","6月","7月","8月","9月"]},yAxis:{type:"value",name:"累计收益率(%)",axisLabel:{formatter:"{value}%"}},series:[{name:"移动平均交叉",type:"line",data:[0,2.3,5.8,9.2,12.5,15.1,18.6,22.4,25.2]},{name:"RSI策略",type:"line",data:[0,1.5,3.8,6.2,8.5,10.1,12.6,14.4,16.2]},{name:"MACD策略",type:"line",data:[0,-1.3,1.8,3.2,5.5,8.1,10.6,13.4,15.2]},{name:"布林带策略",type:"line",data:[0,3.3,2.8,5.2,8.5,12.1,15.6,18.4,21.2]},{name:"沪深300",type:"line",data:[0,1.3,2.8,3.2,2.5,4.1,5.6,4.4,6.2],lineStyle:{type:"dashed"}}]}),[]),f=o.useMemo(()=>({title:{text:"最优资产配置",left:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:10,data:["股票","债券","商品","外汇","现金"]},series:[{name:"资产配置",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:45,name:"股票"},{value:25,name:"债券"},{value:15,name:"商品"},{value:10,name:"外汇"},{value:5,name:"现金"}]}]}),[]);return e.jsxs("div",{children:[e.jsx(ur,{level:2,children:"仪表盘"}),e.jsx(pr,{children:"欢迎使用量化交易系统，您可以在这里查看市场概况和您的策略表现。"}),e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:6,children:e.jsx(ce,{children:e.jsx(de,{title:"本月最佳策略",value:"移动平均交叉",prefix:e.jsx(La,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{children:e.jsx(de,{title:"最佳策略收益",value:25.2,precision:2,valueStyle:{color:"#3f8600"},prefix:e.jsx(Pa,{}),suffix:"%"})})}),e.jsx(b,{span:6,children:e.jsx(ce,{children:e.jsx(de,{title:"最差策略收益",value:-2.1,precision:2,valueStyle:{color:"#cf1322"},prefix:e.jsx(Na,{}),suffix:"%"})})}),e.jsx(b,{span:6,children:e.jsx(ce,{children:e.jsx(de,{title:"策略总数",value:8,prefix:e.jsx(Ta,{})})})})]}),e.jsxs(pe,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(b,{span:12,children:e.jsx(ce,{title:"主要市场指数",extra:e.jsx(M,{type:"link",children:"查看更多"}),children:e.jsx(Xe,{dataSource:r,renderItem:u=>e.jsxs(Xe.Item,{children:[e.jsx(Xe.Item.Meta,{title:u.name}),e.jsx("div",{children:u.value}),e.jsxs("div",{style:{color:u.color,marginLeft:"16px"},children:[u.change>0?"+":"",u.change,"%"]})]})})})}),e.jsx(b,{span:12,children:e.jsx(ce,{title:"最近的回测",extra:e.jsx(M,{type:"link",children:"查看全部"}),children:e.jsx(Xe,{dataSource:a,renderItem:u=>e.jsxs(Xe.Item,{children:[e.jsx(Xe.Item.Meta,{title:u.name,description:`${u.symbol} | ${u.date}`}),e.jsxs("div",{style:{color:u.return>0?"#3f8600":"#cf1322",fontWeight:"bold"},children:[u.return>0?"+":"",u.return,"%"]})]})})})})]}),e.jsxs(pe,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(b,{span:16,children:e.jsx(ce,{title:"策略绩效比较",extra:e.jsx(M,{type:"link",icon:e.jsx(dt,{}),children:"详细分析"}),children:e.jsx("div",{className:"chart-container",children:e.jsx(_t,{option:n,style:{height:"100%"}})})})}),e.jsx(b,{span:8,children:e.jsx(ce,{title:"最优资产配置",children:e.jsx("div",{className:"chart-container",children:e.jsx(_t,{option:f,style:{height:"100%"}})})})})]})]})});var ut=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const ps=()=>ut(void 0,null,function*(){try{const r=yield K.get("/api/data/stocks");return r.data&&Array.isArray(r.data)?r.data.map(a=>({id:a.id.toString(),symbol:a.symbol,name:a.name,type:a.type||"未知",exchange:a.exchange,source_id:a.source_id,data_count:a.data_count||0,last_updated:a.last_updated,first_date:a.first_date,last_date:a.last_date})):[]}catch(r){throw console.error("获取交易品种列表失败:",r),r}}),aa=()=>ut(void 0,null,function*(){try{const r=yield K.get("/api/data/list");return r.data&&Array.isArray(r.data)?r.data:[]}catch(r){throw console.error("获取数据源列表失败:",r),r}}),mr=r=>ut(void 0,null,function*(){try{const a=yield K.get(`/api/data/chart/${r}`);return a.data&&a.data.data?a.data:{data:[]}}catch(a){throw console.error("获取图表数据失败:",a),a}});function fr(r){return ut(this,null,function*(){try{console.log("保存策略数据:",JSON.stringify(r,null,2));let a;if(r.id?a=yield K.put(`/api/strategies/${r.id}`,r):a=yield K.post("/api/strategies",r),console.log("策略保存响应:",a.data),a.data&&a.data.status==="success")return a.data.data;if(a.data)return a.data;throw new Error("保存策略失败，返回数据格式错误")}catch(a){throw console.error("保存策略时发生错误:",a),a}})}const Lt=()=>ut(void 0,null,function*(){try{const r=yield K.get("/api/strategies");return r.data&&r.data.data?r.data.data:[]}catch(r){throw console.error("获取策略列表失败:",r),r}}),Ss=r=>ut(void 0,null,function*(){try{const a=yield K.get(`/api/strategies/${r}`);if(a.data&&a.data.data)return a.data.data;throw new Error("未找到策略数据")}catch(a){throw console.error(`获取策略(ID:${r})详情失败:`,a),a}}),ra=r=>ut(void 0,null,function*(){try{yield K.delete(`/api/strategies/${r}`)}catch(a){throw console.error(`删除策略(ID:${r})失败:`,a),a}}),xr=r=>ut(void 0,null,function*(){try{const a=yield K.get(`/api/strategies/templates/${r}`);if(a.data&&a.data.data)return a.data.data;throw new Error("未找到策略模板数据")}catch(a){throw console.error(`获取策略模板(ID:${r})详情失败:`,a),a}}),gr=r=>ut(void 0,null,function*(){try{const a=yield K.get(`/api/data/stock/${r}/date-range`);if(a.data)return a.data;throw new Error("未找到股票日期范围数据")}catch(a){throw console.error(`获取股票(ID:${r})日期范围失败:`,a),a}}),yr=()=>ut(void 0,null,function*(){try{const r=yield K.post("/api/data/update-all");if(r.data)return r.data;throw new Error("一键更新失败，返回数据格式错误")}catch(r){throw console.error("一键更新所有股票数据失败:",r),r}}),ks=(r,a,n=30)=>{const f=new Date;f.setTime(f.getTime()+n*24*60*60*1e3),document.cookie=`${r}=${a};expires=${f.toUTCString()};path=/`},$s=r=>{const a=r+"=",n=document.cookie.split(";");for(let f=0;f<n.length;f++){let u=n[f];for(;u.charAt(0)===" ";)u=u.substring(1,u.length);if(u.indexOf(a)===0)return u.substring(a.length,u.length)}return null},Oe={setPageSize:r=>{ks("data_management_page_size",r.toString())},getPageSize:(r=15)=>{const a=$s("data_management_page_size");return a?parseInt(a,10):r},setCurrentPage:r=>{ks("data_management_current_page",r.toString())},getCurrentPage:(r=1)=>{const a=$s("data_management_current_page");return a?parseInt(a,10):r}};function jr(r,a){const[n,f]=o.useState(r);return o.useEffect(()=>{const u=setTimeout(()=>{f(r)},a);return()=>{clearTimeout(u)}},[r,a]),n}var br=Object.defineProperty,vr=Object.defineProperties,_r=Object.getOwnPropertyDescriptors,Vt=Object.getOwnPropertySymbols,na=Object.prototype.hasOwnProperty,oa=Object.prototype.propertyIsEnumerable,Ds=(r,a,n)=>a in r?br(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,Yt=(r,a)=>{for(var n in a||(a={}))na.call(a,n)&&Ds(r,n,a[n]);if(Vt)for(var n of Vt(a))oa.call(a,n)&&Ds(r,n,a[n]);return r},zs=(r,a)=>vr(r,_r(a)),wr=(r,a)=>{var n={};for(var f in r)na.call(r,f)&&a.indexOf(f)<0&&(n[f]=r[f]);if(r!=null&&Vt)for(var f of Vt(r))a.indexOf(f)<0&&oa.call(r,f)&&(n[f]=r[f]);return n};const wt=o.memo(r=>{var a=r,{virtualScroll:n=!1,itemHeight:f=54,maxHeight:u=400,dataSource:x=[],columns:w=[]}=a,$=wr(a,["virtualScroll","itemHeight","maxHeight","dataSource","columns"]);const h=o.useMemo(()=>w.map(J=>zs(Yt({},J),{ellipsis:J.ellipsis!==!1})),[w]),v=o.useMemo(()=>x||[],[x]),F=o.useMemo(()=>Yt({size:"middle",scroll:{x:"max-content",y:u},pagination:Yt({showSizeChanger:!0,showQuickJumper:!0,showTotal:(J,y)=>`第 ${y[0]}-${y[1]} 条，共 ${J} 条`},$.pagination)},$),[u,$]);return e.jsx("div",{className:"optimized-table-container",children:e.jsx(Ws,zs(Yt({},F),{columns:h,dataSource:v,className:`optimized-table ${$.className||""}`}))})});wt.displayName="OptimizedTable";var Sr=Object.defineProperty,kr=Object.defineProperties,$r=Object.getOwnPropertyDescriptors,Cs=Object.getOwnPropertySymbols,Dr=Object.prototype.hasOwnProperty,zr=Object.prototype.propertyIsEnumerable,Is=(r,a,n)=>a in r?Sr(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,Cr=(r,a)=>{for(var n in a||(a={}))Dr.call(a,n)&&Is(r,n,a[n]);if(Cs)for(var n of Cs(a))zr.call(a,n)&&Is(r,n,a[n]);return r},Ir=(r,a)=>kr(r,$r(a)),jt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const{Title:Mr,Text:wn}=xt,Ar=o.memo(({onSelect:r})=>{const a=o.useMemo(()=>[{label:"最近7天",days:7},{label:"最近30天",days:30},{label:"最近90天",days:90},{label:"最近180天",days:180},{label:"最近1年",days:365},{label:"最近2年",days:730},{label:"最近3年",days:1095},{label:"最近4年",days:1460},{label:"最近5年",days:1825},{label:"最近10年",days:3650},{label:"今年",type:"year"},{label:"去年",type:"lastYear"},{label:"本月",type:"month"},{label:"上月",type:"lastMonth"}],[]),n=o.useCallback(f=>{const u=B();let x,w;f.type==="year"?(x=u.startOf("year").format("YYYY-MM-DD"),w=u.format("YYYY-MM-DD")):f.type==="lastYear"?(x=u.subtract(1,"year").startOf("year").format("YYYY-MM-DD"),w=u.subtract(1,"year").endOf("year").format("YYYY-MM-DD")):f.type==="month"?(x=u.startOf("month").format("YYYY-MM-DD"),w=u.format("YYYY-MM-DD")):f.type==="lastMonth"?(x=u.subtract(1,"month").startOf("month").format("YYYY-MM-DD"),w=u.subtract(1,"month").endOf("month").format("YYYY-MM-DD")):(x=u.subtract(f.days,"day").format("YYYY-MM-DD"),w=u.format("YYYY-MM-DD")),r(x,w)},[r]);return e.jsx($e,{wrap:!0,children:a.map((f,u)=>e.jsx(M,{size:"small",onClick:()=>n(f),children:f.label},u))})});Ar.displayName="DateRangePresets";const Ms=(r,a)=>{const n=[];for(let f=0,u=a.length;f<u;f++){if(f<r-1){n.push("-");continue}let x=0;for(let w=0;w<r;w++)x+=a[f-w].close;n.push((x/r).toFixed(2))}return n},la=o.memo(()=>{const[r,a]=o.useState([]),[n,f]=o.useState([]),[u,x]=o.useState(!1),[w,$]=o.useState(!1);o.useState([]);const[h]=H.useForm(),[v,F]=o.useState("fetch");o.useState(!1);const[J,y]=o.useState(!1),he=o.useRef(!1),[ve,re]=o.useState({current:Oe.getCurrentPage(),pageSize:Oe.getPageSize(),total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(O,R)=>`第 ${R[0]}-${R[1]} 条，共 ${O} 条`,pageSizeOptions:["10","15","20","50","100"]}),[W,ne]=o.useState(!1),[g,E]=o.useState(null),[C,Se]=o.useState([]),[xe,U]=o.useState(!1),[Ce,Ye]=o.useState("");jr(Ce,300);const q=o.useCallback((...O)=>jt(void 0,[...O],function*(R=Oe.getCurrentPage(),G=Oe.getPageSize()){x(!0);try{const Te=(yield ps()).map(le=>{var Fe;return{id:le.id.toString(),symbol:le.symbol,name:le.name,type:le.type||"未知",exchange:le.exchange,records:le.data_count||0,source:((Fe=le.source_id)==null?void 0:Fe.toString())||"未知",last_updated:le.last_updated?new Date(le.last_updated).toLocaleString():"未知",first_date:le.first_date||void 0,last_date:le.last_date||void 0}});re(le=>Ir(Cr({},le),{current:R,pageSize:G,total:Te.length})),a(Te)}catch(ee){console.error("获取数据列表失败:",ee),m.error("获取数据列表失败，请检查网络连接")}finally{x(!1)}}),[]),Le=o.useCallback(()=>jt(void 0,null,function*(){try{const O=yield aa();if(f(O),v==="fetch"){const R=O.find(G=>G.name==="AkShare抓取");R&&h.setFieldsValue({source_id:R.id})}else if(v==="upload"){const R=O.find(G=>G.name==="用户上传");R&&h.setFieldsValue({source_id:R.id})}}catch(O){console.error("获取数据源列表失败:",O),m.error("获取数据源列表失败")}}),[v,h]),X=o.useCallback(O=>{const{current:R,pageSize:G}=O;Oe.setCurrentPage(R),Oe.setPageSize(G),q(R,G)},[q]),Me=o.useCallback(O=>jt(void 0,null,function*(){x(!0);try{const R=yield K.get(`/api/data/download/${O}`,{responseType:"blob"}),G=window.URL.createObjectURL(new Blob([R.data])),ee=document.createElement("a");ee.href=G;const Te=R.headers["content-disposition"];let le="stock_data.csv";if(Te){const Fe=Te.match(/filename="?(.+)"?/);Fe&&Fe.length===2&&(le=Fe[1])}ee.setAttribute("download",le),document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),m.success("数据下载成功")}catch(R){console.error("下载失败:",R),m.error("下载失败，请重试")}finally{x(!1)}}),[]),Ee=o.useCallback(O=>jt(void 0,null,function*(){ke.confirm({title:"确认删除",content:"此操作将永久删除该数据，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>jt(void 0,null,function*(){var R;x(!0);try{const G=yield K.delete(`/api/data/delete/${O}`);G.data&&G.data.status==="success"?(m.success(G.data.message||"删除成功"),q()):m.error(((R=G.data)==null?void 0:R.message)||"删除失败")}catch(G){console.error("删除失败:",G),m.error("删除失败，请重试")}finally{x(!1)}})})}),[q]),Ne=o.useCallback(O=>jt(void 0,null,function*(){E(O),ne(!0),U(!0);try{const R=yield mr(O.id);console.log("API响应数据:",R);const G=R.data||R||[];console.log("处理后的数据:",G),Se(G)}catch(R){console.error("获取图表数据失败:",R),m.error("获取图表数据失败")}finally{U(!1)}}),[]),Ue=o.useMemo(()=>[{title:"代码",dataIndex:"symbol",key:"symbol",width:100},{title:"名称",dataIndex:"name",key:"name",width:120},{title:"类型",dataIndex:"type",key:"type",width:80,render:O=>e.jsx(be,{color:"blue",children:O})},{title:"交易所",dataIndex:"exchange",key:"exchange",width:80},{title:"记录数",dataIndex:"records",key:"records",width:80,sorter:(O,R)=>O.records-R.records},{title:"数据时间范围",key:"date_range",width:200,render:(O,R)=>R.first_date&&R.last_date?e.jsx("div",{children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[R.first_date," 至 ",R.last_date]})}):e.jsx("span",{style:{color:"#999"},children:"暂无数据"})},{title:"数据源",dataIndex:"source",key:"source",width:100},{title:"最后更新",dataIndex:"last_updated",key:"last_updated",width:150},{title:"操作",key:"action",width:280,render:(O,R)=>e.jsxs($e,{size:"small",children:[e.jsx(M,{type:"primary",icon:e.jsx(Us,{}),size:"small",onClick:()=>Me(R.id),children:"下载"}),e.jsx(M,{icon:e.jsx(dt,{}),size:"small",onClick:()=>Ne(R),children:"K线图"}),e.jsx(M,{danger:!0,icon:e.jsx(Nt,{}),size:"small",onClick:()=>Ee(R.id),children:"删除"})]})}],[Me,Ne,Ee]),Ge=o.useCallback(()=>{ke.confirm({title:"一键更新确认",content:"确定要更新所有股票的最新数据吗？此操作可能需要较长时间。",okText:"确定更新",cancelText:"取消",onOk:()=>jt(void 0,null,function*(){var O,R;y(!0);try{const G=yield yr();if(G&&G.status==="success"){const{summary:ee}=G;if(ee.error===0)m.success(`一键更新完成！成功更新 ${ee.success} 个股票数据`);else{m.success(`一键更新完成！成功更新 ${ee.success} 个，失败 ${ee.error} 个`);const Te=G.results.filter(Fe=>Fe.status==="error");console.warn("更新失败的股票:",Te);const le=Te.slice(0,3).map(Fe=>`${Fe.symbol}: ${Fe.message}`).join("; ");Te.length>3?m.warning(`部分股票更新失败: ${le}... (共${Te.length}个失败)`):m.warning(`部分股票更新失败: ${le}`)}q()}else m.error("一键更新失败")}catch(G){console.error("一键更新失败:",G);const ee=(R=(O=G.response)==null?void 0:O.data)==null?void 0:R.detail;ee?typeof ee=="object"?m.error(JSON.stringify(ee)):m.error(ee):m.error("一键更新失败，请重试")}finally{y(!1)}})})},[q]);return o.useEffect(()=>{he.current||(he.current=!0,q(),Le())},[q,Le]),e.jsxs("div",{className:"data-management",children:[e.jsxs(ce,{children:[e.jsxs(pe,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(b,{children:e.jsx(Mr,{level:4,children:"市场数据管理"})}),e.jsx(b,{children:e.jsxs($e,{children:[e.jsx(M,{type:"primary",icon:e.jsx(Fa,{}),onClick:()=>$(!0),children:"添加数据"}),e.jsx(M,{type:"primary",icon:e.jsx(Rt,{}),loading:J,onClick:Ge,style:{backgroundColor:"#52c41a",borderColor:"#52c41a"},children:"一键更新"}),e.jsx(M,{icon:e.jsx(Rt,{}),onClick:()=>q(ve.current,ve.pageSize),children:"刷新列表"})]})})]}),e.jsx(Ct,{spinning:u,children:e.jsx(wt,{columns:Ue,dataSource:r,rowKey:"id",bordered:!0,size:"middle",pagination:ve,onChange:X})})]}),e.jsx(ke,{title:g?`${g.name}(${g.symbol}) K线图`:"K线图",open:W,onCancel:()=>ne(!1),footer:null,width:800,children:e.jsx(Ct,{spinning:xe,children:C.length>0?e.jsx("div",{style:{height:"500px",width:"100%"},children:e.jsx(qs,{option:{backgroundColor:"#fff",title:{text:g==null?void 0:g.symbol,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:C.map(O=>O.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:C.map(O=>O.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:C.map(O=>[O.open,O.close,O.low,O.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:Ms(5,C),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:Ms(10,C),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:C.map((O,R)=>[R,O.volume,O.close>O.open?1:-1])}]},style:{height:"100%",width:"100%"},opts:{renderer:"canvas"}})}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx("p",{children:"暂无数据可供显示"})})})})]})});la.displayName="DataManagement";var lt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const{Title:Lr,Paragraph:Pr}=xt,{confirm:Nr}=ke,Tr=()=>{const r=Es();St();const[a,n]=o.useState("visual"),[f,u]=o.useState(`# 策略示例：移动平均线交叉策略
import pandas as pd
import numpy as np
import talib

def initialize(context):
    """初始化策略参数"""
    context.params = {
        'symbol': '000300.SH',
        'short_period': 20,
        'long_period': 60
    }

def handle_data(context, data):
    """处理每个交易日的数据"""
    params = context.params
    df = data[params['symbol']]
    
    # 计算移动平均线
    df['short_ma'] = talib.SMA(df['close'], timeperiod=params['short_period'])
    df['long_ma'] = talib.SMA(df['close'], timeperiod=params['long_period'])
    
    # 生成交易信号
    df['signal'] = 0
    # 短均线上穿长均线，买入信号
    df.loc[(df['short_ma'] > df['long_ma']) & (df['short_ma'].shift(1) <= df['long_ma'].shift(1)), 'signal'] = 1
    # 短均线下穿长均线，卖出信号
    df.loc[(df['short_ma'] < df['long_ma']) & (df['short_ma'].shift(1) >= df['long_ma'].shift(1)), 'signal'] = -1
    
    return df['signal']
`),[x]=H.useForm(),[w,$]=o.useState([]),[h,v]=o.useState(!1),[F,J]=o.useState(null);o.useState(!1);const[y,he]=o.useState([]),[ve,re]=o.useState(!1),[W,ne]=o.useState(""),[g,E]=o.useState([]),[C,Se]=o.useState(!1),[xe,U]=o.useState([{label:"移动平均线交叉策略",value:"ma_cross"},{label:"布林带策略",value:"bbands"},{label:"RSI策略",value:"rsi"},{label:"MACD策略",value:"macd"},{label:"趋势跟踪策略",value:"trend_following"},{label:"双均线策略",value:"dual_ma"}]),[Ce,Ye]=o.useState({}),[q,Le]=o.useState(!1),[X,Me]=o.useState(!1),Ee=()=>new URLSearchParams(r.search).get("id"),[Ne,Ue]=o.useState(!1);o.useEffect(()=>{(()=>lt(void 0,null,function*(){if(Ne){const T=Ee();T&&(!F||F.id!==T)&&(yield O(T));return}Ue(!0);try{yield Promise.all([R(),Te()]),yield Ge()}catch(T){console.error("初始化数据加载失败:",T),m.error("数据加载失败，请刷新页面重试")}}))()},[r.search,Ne]);const Ge=()=>lt(void 0,null,function*(){if(!ve){re(!0);try{const T=(yield Lt()).filter(d=>!d.is_template);he(T),console.log("加载到策略列表:",T.length,"个策略");const ie=Ee();ie?(!F||F.id!==ie)&&(yield O(ie)):T.length>0&&!F&&(yield G(T[0]))}catch(N){console.error("获取策略列表失败:",N),m.error("获取策略列表失败")}finally{re(!1)}}}),O=N=>lt(void 0,null,function*(){const T={strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"};if(N)try{v(!0);const ie=yield Ss(N);J(ie),ie.code&&(n("code"),u(ie.code));const d={strategyName:ie.name,description:ie.description,template:ie.template||"ma_cross"};ie.parameters&&(console.log("加载策略参数:",ie.parameters),Object.assign(d,ie.parameters)),console.log("设置表单值:",d),x.setFieldsValue(d)}catch(ie){console.error("加载策略详情失败:",ie),m.error("加载策略详情失败"),x.setFieldsValue(T)}finally{v(!1)}else x.setFieldsValue(T)}),R=()=>lt(void 0,null,function*(){if(w.length>0)return w;v(!0);try{const N=yield ps();return $(N),N}catch(N){console.error("获取股票列表失败:",N)}finally{v(!1)}return[]}),G=N=>lt(void 0,null,function*(){if(N.id)try{v(!0);const T=yield Ss(N.id);J(T),T.code?(n("code"),u(T.code)):n("visual");const ie={strategyName:T.name,description:T.description,template:T.template||"ma_cross"};T.parameters&&(console.log("加载策略参数:",T.parameters),Object.assign(ie,T.parameters)),console.log("设置表单值:",ie),x.setFieldsValue(ie),window.history.replaceState(null,"",`?id=${N.id}`)}catch(T){console.error("加载策略详情失败:",T),m.error("加载策略详情失败")}finally{v(!1)}}),ee=N=>{Nr({title:"确定要删除这个策略吗?",icon:e.jsx(Ba,{}),content:"此操作不可撤销，删除后数据将无法恢复。",okText:"是的，删除",okType:"danger",cancelText:"取消",onOk(){return lt(this,null,function*(){try{yield ra(N.id),m.success("策略删除成功"),F&&F.id===N.id&&(J(null),x.resetFields(),x.setFieldsValue({strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"}),window.history.replaceState(null,"",window.location.pathname)),ve||lt(this,null,function*(){const d=(yield Lt()).filter(t=>!t.is_template);he(d)})}catch(T){console.error("删除策略失败:",T),m.error("删除策略失败")}})}})};y.filter(N=>{var T,ie;return((T=N.name)==null?void 0:T.toLowerCase().includes(W.toLowerCase()))||((ie=N.description)==null?void 0:ie.toLowerCase().includes(W.toLowerCase()))});const Te=()=>lt(void 0,null,function*(){if(xe.length>0&&xe[0].value!=="ma_cross")return xe;try{const T=(yield Lt()).filter(ie=>ie.is_template).map(ie=>({label:ie.name,value:ie.id}));if(T.length>0)return U(T),T}catch(N){console.error("获取策略模板失败:",N)}return xe}),le=N=>lt(void 0,null,function*(){try{const T=yield xr(N);T&&(x.setFieldsValue({name:`自定义${T.name}`,description:T.description,code:T.code}),T.parameters&&Ye(T.parameters),m.success("模板加载成功"))}catch{m.error("加载模板失败")}}),Fe=N=>{le(N)},tt={name:"",description:"",code:""},kt=N=>{Le(!0),fr(N).then(T=>lt(void 0,null,function*(){if(m.success("策略保存成功"),T&&(J(T),window.history.replaceState(null,"",`?id=${T.id}`),!ve)){const d=(yield Lt()).filter(t=>!t.is_template);he(d)}})).catch(T=>{m.error("保存策略失败: "+T.message)}).finally(()=>{Le(!1)})},He=()=>{Me(!0),setTimeout(()=>{m.success("策略测试成功"),Me(!1)},1500)},nt=N=>{x.resetFields(),m.success("已重置为"+N+"模板")},gt=()=>[{key:"mine",label:"我的策略",children:e.jsx(Xe,{itemLayout:"horizontal",dataSource:y,loading:ve,renderItem:N=>e.jsx(Xe.Item,{className:"strategy-list-item",actions:[e.jsx(M,{type:"link",size:"small",onClick:()=>G(N),children:"编辑"},"edit"),e.jsx(M,{type:"link",danger:!0,size:"small",onClick:()=>ee(N),children:"删除"},"delete")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:N.name}),e.jsx("div",{className:"strategy-desc",children:N.description})]})})})},{key:"templates",label:"策略模板",children:e.jsx(Xe,{itemLayout:"horizontal",dataSource:g,loading:C,renderItem:N=>e.jsx(Xe.Item,{className:"strategy-list-item",actions:[e.jsx(M,{type:"link",size:"small",onClick:()=>Fe(N.id),children:"使用"},"use")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:N.name}),e.jsx("div",{className:"strategy-desc",children:N.description})]})})})}];return e.jsxs("div",{className:"strategy-builder",children:[e.jsxs("div",{className:"page-header",style:{marginBottom:"20px"},children:[e.jsx(Lr,{level:2,children:"策略构建器"}),e.jsx(Pr,{children:"创建和测试您的交易策略"})]}),e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:18,children:e.jsx(ce,{title:"策略编辑器",bordered:!1,className:"editor-card",children:e.jsxs(H,{form:x,layout:"vertical",initialValues:tt,onFinish:kt,children:[e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"name",label:"策略名称",rules:[{required:!0,message:"请输入策略名称"},{max:50,message:"策略名称不能超过50个字符"}],children:e.jsx(Be,{placeholder:"请输入策略名称"})})}),e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"description",label:"策略描述",rules:[{max:200,message:"策略描述不能超过200个字符"}],children:e.jsx(Be.TextArea,{placeholder:"请输入策略描述",autoSize:{minRows:1,maxRows:3}})})})]}),e.jsx(H.Item,{name:"code",label:"策略代码",rules:[{required:!0,message:"请输入策略代码"}],children:e.jsx(ka,{height:"450px",extensions:[Oa()],onChange:N=>x.setFieldsValue({code:N})})}),e.jsx(H.Item,{children:e.jsxs($e,{children:[e.jsx(M,{type:"primary",htmlType:"submit",loading:q,children:"保存策略"}),e.jsx(M,{type:"default",onClick:He,loading:X,children:"测试策略"}),e.jsx(Ya,{overlay:e.jsxs(Dt,{children:[e.jsx(Dt.Item,{onClick:()=>nt("basic"),children:"基础策略模板"},"basic"),e.jsx(Dt.Item,{onClick:()=>nt("technical"),children:"技术指标策略"},"technical"),e.jsx(Dt.Item,{onClick:()=>nt("empty"),children:"空白策略"},"empty")]}),children:e.jsxs(M,{children:["重置模板 ",e.jsx(Ra,{})]})})]})})]})})}),e.jsx(b,{span:6,children:e.jsx(ce,{title:"策略库",bordered:!1,className:"strategy-library-card",style:{marginBottom:"16px",height:"300px"},children:e.jsx(Tt,{defaultActiveKey:"mine",items:gt()})})})]})]})};var pt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const ht="http://localhost:8001/api",Fr=r=>pt(void 0,null,function*(){var a;try{const n={};r&&(n.name=r);const f=yield K.get(`${ht}/strategies`,{params:n});if(f.data&&f.data.status==="success")return f.data.data||[];throw new Error(((a=f.data)==null?void 0:a.message)||"获取策略列表失败")}catch(n){return m.error(`获取策略列表错误: ${n.message}`),[]}}),Or=r=>pt(void 0,null,function*(){var a;try{const n=yield K.get(`${ht}/strategies/${r}`);if(n.data&&n.data.status==="success")return n.data.data;throw new Error(((a=n.data)==null?void 0:a.message)||"获取策略详情失败")}catch(n){return m.error(`获取策略详情错误: ${n.message}`),null}}),Yr=r=>pt(void 0,null,function*(){var a;try{const n=yield K.post(`${ht}/strategies`,r);if(n.data&&n.data.status==="success")return m.success("策略创建成功"),n.data.data;throw new Error(((a=n.data)==null?void 0:a.message)||"创建策略失败")}catch(n){return m.error(`创建策略错误: ${n.message}`),null}}),Rr=(r,a)=>pt(void 0,null,function*(){var n;try{const f=yield K.put(`${ht}/strategies/${r}`,a);if(f.data&&f.data.status==="success")return m.success("策略更新成功"),f.data.data;throw new Error(((n=f.data)==null?void 0:n.message)||"更新策略失败")}catch(f){return m.error(`更新策略错误: ${f.message}`),null}}),Br=(r,a,n)=>pt(void 0,null,function*(){var f;try{const u={code:r,data:a||[],parameters:n||{}},x=yield K.post(`${ht}/strategies/test`,u);if(x.data&&x.data.status==="success")return x.data.data;throw new Error(((f=x.data)==null?void 0:f.message)||"测试策略失败")}catch(u){return m.error(`测试策略错误: ${u.message}`),{error:u.message}}}),As=(r,a,n,f,...u)=>pt(void 0,[r,a,n,f,...u],function*(x,w,$,h,v=1e5,F={},J=.0015,y=.001,he="database",ve=[]){var re;try{const W={strategy_id:x,symbol:w,start_date:$,end_date:h,initial_capital:v,parameters:F,commission_rate:J,slippage_rate:y,data_source:he,features:ve},ne=yield K.post(`${ht}/strategies/backtest`,W);if(ne.data&&ne.data.status==="success")return ne.data.data;throw new Error(((re=ne.data)==null?void 0:re.message)||"策略回测失败")}catch(W){return m.error(`策略回测错误: ${W.message}`),{error:W.message}}}),Er=(r,a,n,f,...u)=>pt(void 0,[r,a,n,f,...u],function*(x,w,$,h,v=1e5,F={},J=.0015,y=.001,he="database",ve=[]){var re;try{const W={strategy_id:x,symbol:w,start_date:$,end_date:h,initial_capital:v,parameters:F,commission_rate:J,slippage_rate:y,data_source:he,features:ve,force_refresh:!0},ne=yield K.post(`${ht}/strategies/backtest`,W);if(ne.data&&ne.data.status==="success")return ne.data.data;throw new Error(((re=ne.data)==null?void 0:re.message)||"策略回测失败")}catch(W){return m.error(`策略回测错误: ${W.message}`),{error:W.message}}}),qr=(r,a,n,f,...u)=>pt(void 0,[r,a,n,f,...u],function*(x,w,$,h,v=1e5,F={},J=.0015,y=.001,he="database",ve=[],re="normal"){var W;try{const ne=re==="high"?1:0,g={strategy_id:x.toString(),symbol:w,start_date:$,end_date:h,initial_capital:v,parameters:F,commission_rate:J,slippage_rate:y,data_source:he,features:ve,priority:ne},E=yield K.post(`${ht}/async/backtest/submit`,g);if(E.data&&E.data.task_id)return E.data;throw new Error(((W=E.data)==null?void 0:W.message)||"提交异步回测任务失败")}catch(ne){throw m.error(`提交异步回测任务错误: ${ne.message}`),ne}}),Vr=r=>pt(void 0,null,function*(){try{return(yield K.get(`${ht}/async/backtest/status/${r}`)).data}catch(a){throw m.error(`获取任务状态错误: ${a.message}`),a}}),Kr=r=>pt(void 0,null,function*(){try{return(yield K.get(`${ht}/async/backtest/result/${r}`)).data}catch(a){throw m.error(`获取回测结果错误: ${a.message}`),a}});var Hr=Object.defineProperty,Wr=Object.defineProperties,Ur=Object.getOwnPropertyDescriptors,Ls=Object.getOwnPropertySymbols,Gr=Object.prototype.hasOwnProperty,Zr=Object.prototype.propertyIsEnumerable,Ps=(r,a,n)=>a in r?Hr(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,Wt=(r,a)=>{for(var n in a||(a={}))Gr.call(a,n)&&Ps(r,n,a[n]);if(Ls)for(var n of Ls(a))Zr.call(a,n)&&Ps(r,n,a[n]);return r},Ut=(r,a)=>Wr(r,Ur(a)),rt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});ts([ss,as,rs,ns,os,ls,Ea,qa,Va,is,Ka,cs]);Gs.locale("zh-cn");const{Title:Jr,Paragraph:Qr}=xt,{Option:At}=et,Xr=()=>{var r;const a=St(),[n,f]=o.useState(!1),[u,x]=o.useState(!1),[w,$]=o.useState(1e5),[h,v]=o.useState(.15),[F,J]=o.useState(.1),[y,he]=o.useState([]),[ve,re]=o.useState(!1),[W,ne]=o.useState(1),[g,E]=o.useState("MA交叉策略"),[C,Se]=o.useState(null),[xe,U]=o.useState([B().subtract(1,"year").startOf("day"),B().endOf("day")]),[Ce,Ye]=o.useState([]),[q,Le]=o.useState([]),[X,Me]=o.useState([]),[Ee,Ne]=o.useState([]),[Ue,Ge]=o.useState([]),[O,R]=o.useState({totalReturn:0,annualReturn:0,sharpeRatio:0,maxDrawdown:0,winRate:0,profitFactor:0,alpha:0,beta:0}),[G,ee]=o.useState([]),[Te,le]=o.useState(null),[Fe,tt]=o.useState([]),[kt,He]=o.useState([]),nt=o.useRef(null),gt=o.useRef(!1),[N,T]=o.useState({}),[ie,d]=o.useState(!1),[t,l]=o.useState([]),[c,j]=o.useState(null),[A,z]=o.useState(!1),[ge,te]=o.useState([]),[D,Q]=o.useState(!1),[De,fe]=o.useState(!1),[Ae,L]=o.useState(""),[V,_e]=o.useState(""),[ye,Je]=o.useState(!1),[st,Pe]=o.useState(null),[ot,It]=o.useState(""),[yt,hs]=o.useState(0),[jn,Ft]=o.useState(null),je=s=>typeof s!="string"?String(s):s.includes("T")?s.split("T")[0]:s.includes(" ")?s.split(" ")[0]:/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.substring(0,10),ia=()=>rt(void 0,null,function*(){var s,i;if(!Te||!u){m.error("没有可保存的回测结果");return}if(!Ae.trim()){m.error("请输入回测名称");return}fe(!0);try{const _=xe[0].format("YYYY-MM-DD"),P=xe[1].format("YYYY-MM-DD"),se=yield As(W,C.symbol,_,P,w,{save_backtest:!0,backtest_name:Ae,backtest_description:V,parameters:N},h,F,"database",[]);if(se.error){m.error(`保存失败: ${se.error}`);return}se.saved?(m.success("回测保存成功！"),Q(!1),L(""),_e(""),ke.confirm({title:"保存成功",content:"回测已成功保存，是否查看回测历史？",okText:"查看历史",cancelText:"继续回测",onOk:()=>{a("/backtest/history")}})):m.error("保存失败，请重试")}catch(_){console.error("保存回测失败:",_),m.error(((i=(s=_.response)==null?void 0:s.data)==null?void 0:i.detail)||"保存失败，请重试")}finally{fe(!1)}}),ms=o.useCallback(()=>{console.log("清理轮询定时器，当前pollingIntervalRef.current:",qe.current),qe.current&&(clearInterval(qe.current),qe.current=null,Ft(null),console.log("轮询定时器已清理"))},[]);o.useEffect(()=>()=>{qe.current&&(clearInterval(qe.current),qe.current=null)},[]);const qe=o.useRef(null),fs=o.useCallback(s=>rt(void 0,null,function*(){try{const i=yield Vr(s);if(console.log("任务状态:",i),It(i.status),hs(i.progress||0),i.status==="completed"){console.log("任务已完成，准备清理轮询"),qe.current&&(console.log("立即清理轮询定时器，ID:",qe.current),clearInterval(qe.current),qe.current=null,Ft(null));try{let _;if(i.result&&Object.keys(i.result).length>0?(console.log("从状态响应中获取结果，避免额外请求"),_=i.result):(console.log("状态响应中无结果，发起结果请求"),_=yield Kr(s)),console.log("异步回测结果:",_),_&&_.status==="error")console.error("回测执行失败:",_.message),m.error(`回测失败: ${_.message}`);else{const P=_.data||_;console.log("提取的回测数据:",P),Ht(P),m.success("异步回测完成")}}catch(_){console.error("获取回测结果失败:",_),m.error(`获取回测结果失败: ${_.message}`)}re(!1),Pe(null)}else i.status==="failed"&&(console.log("任务失败，准备清理轮询"),qe.current&&(console.log("立即清理轮询定时器，ID:",qe.current),clearInterval(qe.current),qe.current=null,Ft(null)),re(!1),Pe(null),m.error(`异步回测失败: ${i.error||"未知错误"}`))}catch(i){console.error("获取任务状态失败:",i)}}),[]),Ht=o.useCallback(s=>{var i,_,P,se;if(s.error){m.error(`回测失败: ${s.error}`);return}if(console.log("回测结果:",s),console.log("回测结果关键字段:"),console.log("- total_return:",s.total_return),console.log("- annual_return:",s.annual_return),console.log("- sharpe_ratio:",s.sharpe_ratio),console.log("- max_drawdown:",s.max_drawdown),console.log("- win_rate:",s.win_rate),console.log("- profit_factor:",s.profit_factor),console.log("- trades 数量:",(i=s.trades)==null?void 0:i.length),console.log("- equity_curve 数量:",(_=s.equity_curve)==null?void 0:_.length),console.log("- drawdowns 数量:",(P=s.drawdowns)==null?void 0:P.length),s.trades||(s.trades=[],console.warn("未找到交易记录，设置为空数组")),s.equity_curve||(s.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),s.drawdowns||(s.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),R({totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0,alpha:(s.alpha||0)*100,beta:s.beta||0}),console.log("处理后的性能指标:",{totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0}),le(s),s.trades&&s.trades.length>0){const p=s.trades.map((k,oe)=>(console.log("处理交易记录:",k),{key:oe.toString(),date:je(k.date),symbol:(C==null?void 0:C.symbol)||"",direction:k.action==="BUY"?"买入":"卖出",entryPrice:k.action==="BUY"?k.price:void 0,exitPrice:k.action==="SELL"?k.price:void 0,shares:k.shares,value:k.value,profitLoss:k.profit||0,returnPct:(k.profit_percent||0)*100,duration:k.holding_days||0,beforeCash:k.before_cash,afterCash:k.after_cash,beforeEquity:k.before_equity,afterEquity:k.after_equity,trigger_reason:k.trigger_reason,available_capital:k.available_capital,allocated_capital:k.allocated_capital,position_size:k.position_size,cumulative_position_ratio:k.cumulative_position_ratio})).sort((k,oe)=>new Date(oe.date).getTime()-new Date(k.date).getTime());Le(p),tt(p)}else Le([]),tt([]);if(s.equity_curve&&s.equity_curve.length>0){console.log("处理权益曲线数据:",s.equity_curve[0]);const we=s.equity_curve.map(k=>({date:je(k.date),equity:k.equity}));Ne(we),He(we);const p=s.equity_curve.map(k=>{const oe=je(k.date),ae=Number(k.open)||0,S=Number(k.close)||0,I=Number(k.low)||0,Y=Number(k.high)||0,Z=Number(k.volume)||0;return[oe,ae,S,I,Y,Z]});console.log("K线数据示例(前3条):",p.slice(0,3)),Me(p)}else Ne([]),He([]),Me([]);if(s.drawdowns&&s.drawdowns.length>0){const we=s.drawdowns.map(p=>({date:je(p.date),drawdown:(p.drawdown||0)*100}));Ge(we)}else Ge([]);x(!0),(se=nt.current)==null||se.scrollIntoView({behavior:"smooth"})},[je,C]),ca=o.useCallback(()=>rt(void 0,null,function*(){if(!W||!C||!xe[0]||!xe[1]){m.error("请选择策略、交易品种和回测周期");return}re(!0),le(null),x(!1);try{const s=xe[0].format("YYYY-MM-DD"),i=xe[1].format("YYYY-MM-DD");if(ye){console.log("使用异步模式提交回测任务");const _=yield qr(W,C.symbol,s,i,w,{save_backtest:!1,parameters:N},h,F,"database",[],"normal");console.log("异步任务提交成功:",_),Pe(_.task_id),It("pending"),hs(0);const P=setInterval(()=>{fs(_.task_id)},2e3);qe.current=P,Ft(P),m.info("回测任务已提交，正在后台执行...")}else{console.log("使用同步模式执行回测");const _=yield As(W,C.symbol,s,i,w,{save_backtest:!1,parameters:N},h,F,"database",[]);Ht(_),(()=>{m.success("回测完成")})(),re(!1)}}catch(s){console.error("回测执行失败:",s),m.error(`回测失败: ${s.message||"未知错误"}`),re(!1),Pe(null),ms()}}),[W,C,xe,w,h,F,N,ye,Ht,fs,ms]),da=o.useCallback(()=>rt(void 0,null,function*(){var s,i,_,P;if(!W||!C||!xe[0]||!xe[1]){m.error("请选择策略、交易品种和回测周期");return}re(!0),le(null),x(!1);try{const se=xe[0].format("YYYY-MM-DD"),we=xe[1].format("YYYY-MM-DD"),p=yield Er(W,C.symbol,se,we,w,{save_backtest:!1,parameters:N},h,F,"database",[]);if(p.error){m.error(`强制刷新回测失败: ${p.error}`);return}if(console.log("强制刷新回测结果:",p),console.log("回测结果关键字段:"),console.log("- total_return:",p.total_return),console.log("- annual_return:",p.annual_return),console.log("- sharpe_ratio:",p.sharpe_ratio),console.log("- max_drawdown:",p.max_drawdown),console.log("- win_rate:",p.win_rate),console.log("- profit_factor:",p.profit_factor),console.log("- trades 数量:",(s=p.trades)==null?void 0:s.length),console.log("- equity_curve 数量:",(i=p.equity_curve)==null?void 0:i.length),console.log("- drawdowns 数量:",(_=p.drawdowns)==null?void 0:_.length),p.trades||(p.trades=[],console.warn("未找到交易记录，设置为空数组")),p.equity_curve||(p.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),p.drawdowns||(p.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),R({totalReturn:(p.total_return||0)*100,annualReturn:(p.annual_return||0)*100,sharpeRatio:p.sharpe_ratio||0,maxDrawdown:(p.max_drawdown||0)*100,winRate:(p.win_rate||0)*100,profitFactor:p.profit_factor||0,alpha:(p.alpha||0)*100,beta:p.beta||0}),console.log("处理后的性能指标:",{totalReturn:(p.total_return||0)*100,annualReturn:(p.annual_return||0)*100,sharpeRatio:p.sharpe_ratio||0,maxDrawdown:(p.max_drawdown||0)*100,winRate:(p.win_rate||0)*100,profitFactor:p.profit_factor||0}),le(p),p.trades&&p.trades.length>0){const ae=p.trades.map((S,I)=>(console.log("处理交易记录:",S),{key:I.toString(),date:je(S.date),symbol:C.symbol,direction:S.action==="BUY"?"买入":"卖出",entryPrice:S.action==="BUY"?S.price:void 0,exitPrice:S.action==="SELL"?S.price:void 0,shares:S.shares,value:S.value,profitLoss:S.profit||0,returnPct:(S.profit_percent||0)*100,duration:S.holding_days||0,beforeCash:S.before_cash,afterCash:S.after_cash,beforeEquity:S.before_equity,afterEquity:S.after_equity,trigger_reason:S.trigger_reason,available_capital:S.available_capital,allocated_capital:S.allocated_capital,position_size:S.position_size,cumulative_position_ratio:S.cumulative_position_ratio})).sort((S,I)=>new Date(I.date).getTime()-new Date(S.date).getTime());Le(ae),tt(ae)}else Le([]),tt([]);if(p.equity_curve&&p.equity_curve.length>0){console.log("处理权益曲线数据:",p.equity_curve[0]);const oe=p.equity_curve.map(S=>({date:je(S.date),equity:S.equity}));Ne(oe),He(oe);const ae=p.equity_curve.map(S=>{const I=je(S.date),Y=Number(S.open)||0,Z=Number(S.close)||0,ue=Number(S.low)||0,Ve=Number(S.high)||0,Ze=Number(S.volume)||0;return[I,Y,Z,ue,Ve,Ze]});console.log("K线数据示例(前3条):",ae.slice(0,3)),Me(ae)}else Ne([]),He([]),Me([]);if(p.drawdowns&&p.drawdowns.length>0){const oe=p.drawdowns.map(ae=>({date:je(ae.date),drawdown:(ae.drawdown||0)*100}));Ge(oe)}else Ge([]);x(!0),(P=nt.current)==null||P.scrollIntoView({behavior:"smooth"}),(()=>{m.success("强制刷新回测完成")})()}catch(se){console.error("强制刷新回测执行失败:",se),m.error(`强制刷新回测失败: ${se.message||"未知错误"}`)}finally{re(!1)}}),[W,C,xe,w,h,F,je,Le,tt,Me,Ne,He,Ge,x,le,R,re]),ua=()=>{const s=C?`${C.name} (${C.symbol}) K线图与交易信号`:"K线图与交易信号";let i=[],_=[];if(!X||X.length===0)return console.warn("K线数据为空，无法生成图表"),{title:{text:s,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};if(q.length>0&&X.length>0){if(console.log("准备标记交易信号，总交易记录：",q.length),console.log("K线数据样本:",X.slice(0,3)),X.length>0){const S=X[0][0];console.log("K线日期格式示例:",{original:S,type:typeof S,split:typeof S=="string"?S.split("T"):null})}if(q.length>0){const S=q[0].date;console.log("交易记录日期格式示例:",{original:S,type:typeof S,split:typeof S=="string"?S.split("T"):null,split2:typeof S=="string"?S.split(" "):null})}const p=new Map,k=new Map;X.forEach((S,I)=>{const Y=je(S[0]);p.set(Y,I),k.set(Y,[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])}),console.log("日期索引映射创建完成，共计:",p.size),console.log("日期映射示例:",Array.from(p.entries()).slice(0,3));const oe=q.filter(S=>S.direction==="买入");console.log("买入记录:",oe.length),i=oe.map(S=>{const I=je(S.date),Y=p.get(I),Z=S.entryPrice||0;return Y===void 0||Z<=0?(console.warn(`未找到买入日期 ${I} 对应的K线索引或价格无效`),null):(console.log(`买入日期匹配成功: ${I} -> 索引 ${Y}, 价格 ${Z}`),{name:"买入",value:[Y,Z],xAxis:Y,yAxis:Z,itemStyle:{color:"#f64034"}})}).filter(S=>S!==null);const ae=q.filter(S=>S.direction==="卖出");console.log("卖出记录:",ae.length),_=ae.map(S=>{const I=je(S.date),Y=p.get(I),Z=S.exitPrice||0,ue=S.profitLoss||0;if(S.returnPct,Y===void 0||Z<=0)return console.warn(`未找到卖出日期 ${I} 对应的K线索引或价格无效`),null;console.log(`卖出日期匹配成功: ${I} -> 索引 ${Y}, 价格 ${Z}, 盈亏 ${ue}`);const Ve=ue>=0?"#f64034":"#00b46a";return{name:"卖出",value:[Y,Z],xAxis:Y,yAxis:Z,itemStyle:{color:Ve}}}).filter(S=>S!==null),console.log(`成功生成买入信号: ${i.length}/${oe.length}`),console.log(`成功生成卖出信号: ${_.length}/${ae.length}`)}const P=X.map(p=>p[0]);let se=[];se=[...i.map(p=>(p.value[0],{name:"买入点",coord:[p.value[0],p.value[1]],value:p.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),..._.map(p=>({name:"卖出点",coord:[p.value[0],p.value[1]],value:p.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...i.map(p=>{const k=p.value[0],ae=X[k][4]*1.1;return{name:"买入标签",coord:[p.value[0],ae],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),..._.map(p=>{const k=p.value[0],oe=i.some(I=>{const Y=I.value[0],Z=je(X[Y][0]),ue=je(X[k][0]);return Z===ue}),ae=X[k][4],S=oe?ae*1.2:ae*1.1;return{name:"卖出标签",coord:[p.value[0],S],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];const we=[...i.map(p=>({name:"买入价格",coord:[p.value[0],p.value[1]*1.03],symbol:"none",label:{show:!0,formatter:`¥${p.value[1].toFixed(2)}`,fontSize:12,color:"#f64034",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"top",distance:8}})),..._.map(p=>{const k=p.value[0],oe=X[k][0],ae=q.find(ue=>ue.direction==="卖出"&&je(ue.date)===je(oe)),S=ae&&ae.profitLoss||0,I=ae&&ae.returnPct||0,Y=S>=0?`+${S.toFixed(2)}`:`${S.toFixed(2)}`,Z=I>=0?`+${I.toFixed(2)}%`:`${I.toFixed(2)}%`;return{name:"卖出价格",coord:[p.value[0],p.value[1]*.97],symbol:"none",label:{show:!0,formatter:ae?`¥${p.value[1].toFixed(2)}
${Y}(${Z})`:`¥${p.value[1].toFixed(2)}`,fontSize:12,color:"#00b46a",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"bottom",distance:8}}})];return{title:{text:s,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(p){let k="";if(Array.isArray(p)){const oe=p[0].axisValue;k=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${oe}</div>`,p.forEach(Y=>{if(Y.seriesName==="K线"){if(Y.value&&Y.value.length>=4){const Z=Number(Y.value[1])||0,ue=Number(Y.value[2])||0,Ve=Number(Y.value[3])||0,Ze=Number(Y.value[4])||0,Ke=ue>=Z?"#f64034":"#00b46a";k+=`<div style="color:${Ke};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${Ke};">${Z.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${Ke};">${ue.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${Ke};">${Ve.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${Ke};">${Ze.toFixed(2)}</span><br/>
                  </div>`}}else if(Y.seriesName&&Y.seriesName.startsWith("MA")&&Y.value!=="-"){const ue={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[Y.seriesName]||Y.color;try{const Ve=typeof Y.value=="number"?parseFloat(Y.value.toString()).toFixed(3):parseFloat(Y.value||"0").toFixed(3);k+=`<div style="color:${ue};font-weight:bold;display:inline-block;margin-right:15px;">${Y.seriesName}：${Ve}</div>`}catch(Ve){console.warn("格式化MA值出错:",Ve),k+=`<div style="color:${ue};font-weight:bold;display:inline-block;margin-right:15px;">${Y.seriesName}：0</div>`}}});const ae=je(oe),S=q.find(Y=>Y.direction==="买入"&&je(Y.date)===ae),I=q.find(Y=>Y.direction==="卖出"&&je(Y.date)===ae);if((S||I)&&(k+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),S){const Y=S.entryPrice||0,Z=S.trigger_reason||"未记录原因";k+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${Y.toFixed(2)}<br/>
                原因：${Z}
              </div>`}if(I){const Y=I.exitPrice||0,Z=I.profitLoss||0,ue=I.returnPct||0,Ve=I.trigger_reason||"未记录原因",Ze=Z>=0?`+${Z.toFixed(2)}`:`${Z.toFixed(2)}`,Ke=ue>=0?`+${ue.toFixed(2)}%`:`${ue.toFixed(2)}%`;k+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${Y.toFixed(2)}<br/>
                盈亏：${Ze} (${Ke})<br/>
                原因：${Ve}
              </div>`}}return k}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:P,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"},min:function(p){return Math.min(0,w*.8)},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:X.map(p=>[Number(p[1]),Number(p[2]),Number(p[3]),Number(p[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:se,animation:!1,z:10}},{name:"价格标签",type:"scatter",data:[],markPoint:{symbol:"none",data:we,animation:!1,z:9}},{name:"MA5",type:"line",data:Ot(5,X.map(p=>[Number(p[1]),Number(p[2]),Number(p[3]),Number(p[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Ot(10,X.map(p=>[Number(p[1]),Number(p[2]),Number(p[3]),Number(p[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Ot(20,X.map(p=>[Number(p[1]),Number(p[2]),Number(p[3]),Number(p[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Ot(30,X.map(p=>[Number(p[1]),Number(p[2]),Number(p[3]),Number(p[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}};function Ot(s,i){if(!i||!Array.isArray(i)||i.length===0)return console.warn(`计算MA${s}失败: 数据无效`),[];console.log(`MA${s}计算 - 输入数据示例:`,i.length>0?i.slice(0,3):"无数据");const _=[];for(let P=0;P<i.length;P++){if(P<s-1){_.push("-");continue}let se=0,we=0;for(let p=0;p<s;p++){const k=i[P-p];if(k&&k.length>=4){const oe=Number(k[1]);!isNaN(oe)&&oe>0&&(se+=oe,we++)}}we>0?_.push((se/we).toFixed(2)):_.push("-")}return _.length>0&&console.log(`MA${s}计算结果示例:`,_.slice(0,5)),_}const pa=[{title:"日期",dataIndex:"date",key:"date",sorter:(s,i)=>{const _=new Date(s.date),P=new Date(i.date);return _.getTime()-P.getTime()}},{title:"方向",dataIndex:"direction",key:"direction",filters:[{text:"买入",value:"买入"},{text:"卖出",value:"卖出"}],onFilter:(s,i)=>i.direction===s,render:s=>e.jsx(be,{color:s==="买入"?"red":"green",children:s})},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:s=>e.jsx(me,{title:s||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:s||"未记录"})})},{title:"期初资金",dataIndex:"beforeCash",key:"beforeCash",sorter:(s,i)=>s.beforeCash-i.beforeCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"afterCash",key:"afterCash",sorter:(s,i)=>s.afterCash-i.afterCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"入场价",dataIndex:"entryPrice",key:"entryPrice",sorter:(s,i)=>{const _=s.entryPrice||0,P=i.entryPrice||0;return _-P},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"出场价",dataIndex:"exitPrice",key:"exitPrice",sorter:(s,i)=>{const _=s.exitPrice||0,P=i.exitPrice||0;return _-P},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(s,i)=>s.shares-i.shares,render:s=>(parseInt(s)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(s,i)=>s.value-i.value,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"盈亏",dataIndex:"profitLoss",key:"profitLoss",sorter:(s,i)=>s.profitLoss-i.profitLoss,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2)]}):e.jsx("span",{style:{color:"#52c41a"},children:i.toFixed(2)})}},{title:"收益率(%)",dataIndex:"returnPct",key:"returnPct",sorter:(s,i)=>s.returnPct-i.returnPct,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00%"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2),"%"]}):e.jsxs("span",{style:{color:"#52c41a"},children:[i.toFixed(2),"%"]})}},{title:"持仓天数",dataIndex:"duration",key:"duration",sorter:(s,i)=>s.duration-i.duration},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(s,i)=>(s.position_size||0)-(i.position_size||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(s,i)=>(s.cumulative_position_ratio||0)-(i.cumulative_position_ratio||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}}],ha=()=>{if(console.log("生成权益曲线图表, 数据长度:",Ee.length),!Ee||Ee.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const s=Ee.filter(I=>I&&I.date&&I.equity!==void 0&&!isNaN(Number(I.equity)));if(s.length===0)return console.error("权益曲线数据无效:",Ee.slice(0,3)),{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};console.log("有效数据点数量:",s.length),console.log("权益曲线数据范围:",s.length>0?`${s[0].date}(${s[0].equity}) ~ ${s[s.length-1].date}(${s[s.length-1].equity})`:"无数据");let i=[],_=[];const P=new Map;s.forEach((I,Y)=>{const Z=je(I.date);P.set(Z,Y)}),q.length>0&&(console.log("准备在权益曲线上标记交易点，总交易记录：",q.length),q.forEach(I=>{const Y=je(I.date),Z=P.get(Y);if(Z!==void 0){const ue={name:I.direction==="买入"?"买入点":"卖出点",value:s[Z].equity,xAxis:Z,yAxis:s[Z].equity,itemStyle:{color:I.direction==="买入"?"#f64034":"#00b46a"}};I.direction==="买入"?i.push(ue):_.push(ue)}}));let se=-1,we=-1,p=0,k="",oe="",ae=0,S=0;if(s.length>0&&O.maxDrawdown>0){let I=s[0].equity,Y=0,Z=0;for(let ue=1;ue<s.length;ue++)s[ue].equity>I?(I=s[ue].equity,Z=ue):(Y=(I-s[ue].equity)/I*100,Y>p&&(p=Y,se=Z,we=ue,k=s[Z].date,oe=s[ue].date,ae=I,S=s[ue].equity));console.log(`最大回测区间索引: ${se} - ${we}`),console.log(`最大回测: ${p.toFixed(2)}%, 从 ${k} 到 ${oe}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(I){if(Array.isArray(I)&&I.length>0){const Z=I[0].axisValue,ue=I[0].data;for(let Ze=0;Ze<I.length;Ze++)if(I[Ze].componentType==="markArea")return`最大回撤: ${p.toFixed(2)}%<br/>
                        开始日期: ${k}<br/>
                        最高点: ¥${ae.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${oe}<br/>
                        最低点: ¥${S.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let Ve="";for(let Ze=0;Ze<I.length;Ze++){const Ke=I[Ze];if(Ke.seriesName==="买入点"||Ke.seriesName==="卖出点"){const Sa=je(Z),ys=q.find(Mt=>je(Mt.date)===Sa&&(Ke.seriesName==="买入点"&&Mt.direction==="买入"||Ke.seriesName==="卖出点"&&Mt.direction==="卖出"));if(ys){const Mt=ys.trigger_reason||"未记录原因";Ve=`<br/><span style="color:${Ke.color}">● ${Ke.seriesName}</span>`,Ve+=`<br/><span style="color:#555; font-size:12px">原因: ${Mt}</span>`}else Ve=`<br/><span style="color:${Ke.color}">● ${Ke.seriesName}</span>`;break}}return`${Z}<br/>策略收益: ¥${parseFloat(ue).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${Ve}`}const Y=I.value;return`${I.name}: ¥${parseFloat(Y).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:s.map(I=>I.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:s.map(I=>I.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new Js(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...i.map(I=>({name:"买入点",coord:[I.xAxis,I.yAxis],value:I.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),..._.map(I=>({name:"卖出点",coord:[I.xAxis,I.yAxis],value:I.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${p.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[se>=0&&we>=0?[{name:"最大回撤开始",xAxis:se,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:we,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:s.map(()=>w),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:w,label:{formatter:"初始资金: ¥"+w.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(I){return`初始资金: ¥${w.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},ma=()=>rt(void 0,null,function*(){try{const s=yield Fr();if(console.log("从后端获取的策略列表:",s),s&&s.length>0)if(ee(s),!s.some(i=>i.id===W))ne(s[0].id||1),E(s[0].name||"移动平均线交叉策略");else{const i=s.find(_=>_.id===W);i&&E(i.name)}else m.error("未找到策略列表，请先创建策略")}catch(s){console.error("获取策略列表失败:",s),m.error("获取策略列表失败，请检查网络连接")}});o.useEffect(()=>{gt.current||(gt.current=!0,fa(),_a(),ma())},[]),o.useEffect(()=>{G.length>0&&W&&gs(W)},[G,W]);const xs=s=>rt(void 0,null,function*(){Se(s);try{const i=yield gr(s.id);if(i.first_date&&i.last_date){const _=B(i.first_date).startOf("day"),P=B(i.last_date).endOf("day");U([_,P]),m.success(`已自动设置回测周期：${i.first_date} 至 ${i.last_date}`)}}catch(i){console.error("获取股票日期范围失败:",i),m.warning("无法获取该股票的数据日期范围，请手动设置回测周期")}}),fa=()=>rt(void 0,null,function*(){re(!0);try{const s=yield ps();he(s),s.length>0&&(yield xs(s[0]))}catch(s){console.error("获取股票列表失败:",s)}finally{re(!1)}}),gs=s=>rt(void 0,null,function*(){try{const i=yield K.get(`/api/optimization/strategies/${s}/parameter-spaces`);if(i.data&&i.data.status==="success"){l(i.data.data);const _={};i.data.data.forEach(P=>{(P.parameter_type==="int"||P.parameter_type==="float")&&(_[P.parameter_name]=P.min_value)}),T(_)}}catch(i){console.error("加载参数空间失败:",i),l([]),T({})}}),xa=()=>{d(!0)},ga=()=>{d(!1),m.success("参数设置已保存")},ya=()=>{const s={};t.forEach(i=>{(i.parameter_type==="int"||i.parameter_type==="float")&&(s[i.parameter_name]=i.min_value)}),T(s),m.success("参数已重置为默认值")},ja=()=>rt(void 0,null,function*(){try{const s=yield K.get(`/api/optimization/strategies/${W}/best-parameters`);s.data&&s.data.status==="success"&&s.data.data.length>0?(te(s.data.data),z(!0)):m.warning("该策略暂无优化结果，请先进行参数优化")}catch(s){console.error("获取优化结果失败:",s),m.error("获取优化结果失败，请检查网络连接")}}),ba=s=>{var i;T(s.best_parameters),z(!1),d(!1),m.success(`已导入优化结果: ${s.job_name} (得分: ${(i=s.best_score)==null?void 0:i.toFixed(4)})`)},va=s=>{ne(s);const i=G.find(_=>_.id===s);i&&(E(i.name),j(i)),gs(s)},_a=()=>rt(void 0,null,function*(){try{const s=yield aa();Ye(s)}catch(s){console.error("获取数据源列表失败:",s)}}),wa=()=>[{key:"1",label:e.jsxs("span",{children:[e.jsx(dt,{}),"绩效分析"]}),children:e.jsx(pe,{gutter:16,children:e.jsx(b,{span:24,style:{marginBottom:16},children:e.jsx(_t,{option:ha(),style:{height:500}})})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(dt,{}),"K线与交易信号"]}),children:e.jsx(pe,{gutter:16,children:e.jsx(b,{span:24,children:e.jsx(ce,{title:C?`${C.name} (${C.symbol})交易图表`:"交易图表",extra:e.jsxs($e,{children:[e.jsx(M,{type:"primary",size:"small",onClick:()=>{const s=document.querySelector(".kline-chart");if(s){const i=s.__echarts__;i&&i.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(M,{size:"small",onClick:()=>{if(q.length>0&&X.length>0){const s=new Map;X.forEach((_,P)=>{const se=je(_[0]);s.set(se,P)});const i=[];if(q.forEach(_=>{const P=je(_.date),se=s.get(P);se!==void 0&&i.push(se)}),console.log("找到的交易日期索引:",i),i.length>0){const _=Math.max(0,Math.min(...i)-10),P=Math.min(X.length-1,Math.max(...i)+10),se=_/X.length*100,we=P/X.length*100;console.log(`设置缩放范围: ${se.toFixed(2)}% - ${we.toFixed(2)}%`);const p=document.querySelector(".kline-chart");if(p){const k=p.__echarts__;k&&(k.dispatchAction({type:"dataZoom",start:se,end:we}),(ae=>{m.success(`已聚焦到交易区域，共显示 ${ae} 个交易点`)})(i.length))}}else(()=>{m.info("未找到交易信号对应的K线数据点")})()}else(()=>{m.info("没有交易记录或K线数据")})()},children:"聚焦交易"}),e.jsx(me,{title:"只显示有交易的区域",children:e.jsx(Ie,{})})]}),children:e.jsx(_t,{className:"kline-chart",option:ua(),style:{height:600},notMerge:!0,opts:{renderer:"canvas"},onEvents:{click:s=>{if(s.componentType==="markPoint"){const _=s.name==="买入",P=s.data.coord[0],se=X[P][0],we=_?"买入":"卖出",p=q.find(k=>k.direction===we&&je(k.date)===je(se));if(console.log(`点击了${we}标记，日期: ${se}`,p),p){const k=p,oe=_?"买入详情":"卖出详情",ae=e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"日期:"})," ",k.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"价格:"})," ",_?k.entryPrice:k.exitPrice]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数量:"})," ",k.shares.toLocaleString()," 股"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"金额:"})," ",k.value.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),!_&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏:"})," ",k.profitLoss>=0?"+":"",k.profitLoss.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"收益率:"})," ",k.returnPct>=0?"+":"",k.returnPct.toFixed(2),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"持仓天数:"})," ",k.duration," 天"]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易前资金:"})," ",k.beforeCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易后资金:"})," ",k.afterCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"触发原因:"})," ",k.trigger_reason||"未记录原因"]})]});ke.info({title:oe,content:ae,width:400})}else((oe,ae)=>{m.info(`未找到匹配的${oe}交易记录，日期: ${ae}`)})(we,se)}}}})})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Ie,{}),"交易明细"]}),children:e.jsx(wt,{dataSource:q,columns:pa,pagination:{pageSize:10},scroll:{x:!0}})}];return e.jsxs("div",{children:[e.jsx(Jr,{level:2,children:"回测分析"}),e.jsx(Qr,{children:"回测您的交易策略，分析策略表现并优化参数。"}),e.jsx(ce,{children:e.jsx(Ct,{spinning:ve,children:e.jsxs(H,{layout:"vertical",children:[e.jsxs(pe,{gutter:24,children:[e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"策略选择",required:!0,children:e.jsxs(Be.Group,{compact:!0,children:[e.jsx(et,{value:g,onChange:(s,i)=>{va(Number(i.key))},placeholder:"选择策略",style:{width:"calc(100% - 80px)"},size:"middle",children:G.map(s=>e.jsx(At,{value:s.name,children:s.name},s.id))}),e.jsx(M,{type:"primary",ghost:!0,onClick:xa,style:{width:"80px"},icon:e.jsx(Kt,{}),size:"middle",children:"参数"})]})})}),e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"交易品种",required:!0,children:e.jsx(et,{value:C==null?void 0:C.symbol,onChange:s=>rt(void 0,null,function*(){const i=y.find(_=>_.symbol===s);i&&(yield xs(i))}),placeholder:"选择交易品种",children:y.map(s=>{var i;return e.jsxs(At,{value:s.symbol,children:[s.name," (",s.symbol,") - ",((i=Ce.find(_=>_.id===s.source_id))==null?void 0:i.name)||"未知数据源"]},s.id)})})})}),e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"回测周期",required:!0,children:e.jsx(Bt.RangePicker,{value:xe,onChange:s=>{s&&s[0]&&s[1]&&U([s[0].startOf("day"),s[1].endOf("day")])},style:{width:"100%"},placeholder:["开始日期","结束日期"],format:"YYYY-MM-DD",allowClear:!1,disabledDate:s=>s&&s>B().endOf("day"),presets:[{label:"Last 7 days",value:[B().subtract(7,"day"),B()]},{label:"Last 30 days",value:[B().subtract(30,"day"),B()]},{label:"Last 3 months",value:[B().subtract(3,"month"),B()]},{label:"Last 6 months",value:[B().subtract(6,"month"),B()]},{label:"Last 1 year",value:[B().subtract(1,"year"),B()]},{label:"Last 3 years",value:[B().subtract(3,"year"),B()]},{label:"Last 5 years",value:[B().subtract(5,"year"),B()]},{label:"Last 7 years",value:[B().subtract(7,"year"),B()]},{label:"Last 10 years",value:[B().subtract(10,"year"),B()]}]})})})]}),e.jsxs(pe,{gutter:24,children:[e.jsx(b,{span:6,children:e.jsx(H.Item,{label:"初始资金",children:e.jsx(ft,{value:w,onChange:s=>$(Number(s)||1e5),formatter:s=>`¥ ${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:s=>{if(s){const i=parseFloat(s.replace(/\¥\s?|(,*)/g,""));return isNaN(i)?w:i}return w},style:{width:"100%"}})})}),e.jsx(b,{span:6,children:e.jsx(H.Item,{label:"手续费率(%)",children:e.jsx(ft,{value:h,onChange:s=>v(Number(s)||.15),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(b,{span:6,children:e.jsx(H.Item,{label:"滑点(%)",children:e.jsx(ft,{value:F,onChange:s=>J(Number(s)||.1),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(b,{span:6,children:e.jsx(H.Item,{label:"基准",children:e.jsxs(et,{defaultValue:"SPY",placeholder:"选择基准",children:[e.jsx(At,{value:"SPY",children:"标普500ETF"}),e.jsx(At,{value:"QQQ",children:"纳斯达克ETF"}),e.jsx(At,{value:"DIA",children:"道琼斯ETF"})]})})})]}),C&&e.jsx(We,{message:`已选择数据源: ${((r=Ce.find(s=>s.id===C.source_id))==null?void 0:r.name)||"未知"}`,description:`回测将使用与数据管理中相同的数据源获取 ${C.symbol} 的历史数据`,type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(H.Item,{label:"执行模式",children:e.jsxs($e,{children:[e.jsx(Ha,{checked:ye,onChange:Je,checkedChildren:"异步",unCheckedChildren:"同步"}),e.jsx(me,{title:ye?"异步模式：任务在后台执行，可以处理大数据量回测":"同步模式：立即返回结果，适合快速回测",children:e.jsx(Ie,{style:{color:"#aaa"}})}),ye&&st&&e.jsxs(be,{color:ot==="completed"?"green":ot==="failed"?"red":"blue",children:["任务状态: ",ot==="pending"?"等待中":ot==="running"?"执行中":ot==="completed"?"已完成":ot==="failed"?"失败":ot,ot==="running"&&` (${yt}%)`]})]})}),e.jsx(H.Item,{children:e.jsxs($e,{children:[e.jsx(M,{type:"primary",icon:e.jsx(Et,{}),loading:n,onClick:ca,children:ye?"提交异步回测":"运行回测"}),e.jsx(M,{type:"default",icon:e.jsx(Et,{}),loading:n,onClick:da,title:"强制刷新：清除缓存并重新运行回测",disabled:ye,children:"强制刷新"})]})})]})})}),u&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{}),e.jsxs(ce,{children:[e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(me,{title:"年化收益率=（总收益率+1）^(365/天数)-1，反映策略年化增长速度",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.annualReturn,precision:2,valueStyle:{color:O.annualReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(me,{title:"最大回撤=历史最高点到最低点的最大跌幅，衡量风险",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:Math.abs(O.maxDrawdown),precision:2,valueStyle:{color:"#52c41a"},suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(me,{title:"夏普比率=（年化收益率-无风险利率）/年化波动率，衡量单位风险收益",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.sharpeRatio,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["胜率 ",e.jsx(me,{title:"胜率=盈利交易次数/总交易次数",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.winRate,precision:2,suffix:"%"})})]}),e.jsxs(pe,{gutter:16,style:{marginTop:24},children:[e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(me,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.profitFactor||0,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["Alpha ",e.jsx(me,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.alpha||0,precision:2,suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["Beta ",e.jsx(me,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:O.beta||0,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["交易次数 ",e.jsx(me,{title:"策略在回测期间的总交易次数",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:q.length})})]}),e.jsx(qt,{}),e.jsx(Tt,{defaultActiveKey:"1",items:wa()}),e.jsxs("div",{style:{textAlign:"right",marginTop:16},children:[e.jsx(M,{icon:e.jsx(Us,{}),style:{marginRight:8},children:"导出报告"}),e.jsx(M,{icon:e.jsx(Zs,{}),type:"primary",onClick:()=>{const s=new Date,i=s.toISOString().slice(0,10).replace(/-/g,""),_=s.toTimeString().slice(0,5).replace(":",""),P=`${(C==null?void 0:C.symbol)||"UNKNOWN"}_v${i}_${_}`;L(P),Q(!0)},disabled:!u,children:"保存回测"})]})]})]}),e.jsx(ke,{title:"保存回测",open:D,onOk:ia,onCancel:()=>{Q(!1),L(""),_e("")},confirmLoading:De,okText:"保存",cancelText:"取消",children:e.jsxs(H,{layout:"vertical",children:[e.jsx(H.Item,{label:"回测名称",required:!0,help:"请输入一个描述性的回测名称",children:e.jsx(Be,{placeholder:"例如：MA交叉策略_AAPL_2024年回测",value:Ae,onChange:s=>L(s.target.value)})}),e.jsx(H.Item,{label:"回测描述",help:"可选：添加回测的详细描述",children:e.jsx(Be.TextArea,{placeholder:"例如：使用移动平均线交叉策略对AAPL进行回测，包含仓位控制...",value:V,onChange:s=>_e(s.target.value),rows:3})}),e.jsx(We,{message:"保存信息",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"策略："}),g]}),e.jsxs("p",{children:[e.jsx("strong",{children:"股票："}),C==null?void 0:C.symbol," (",C==null?void 0:C.name,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"回测期间："}),xe[0].format("YYYY-MM-DD")," 至 ",xe[1].format("YYYY-MM-DD")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"初始资金："}),"$",w.toLocaleString()]}),Object.keys(N).length>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"策略参数："}),"短期均线 ",N.short_window||5,"天, 长期均线 ",N.long_window||20,"天"]})]}),type:"info",showIcon:!0})]})}),e.jsxs(ke,{title:"策略参数设置",open:ie,onOk:ga,onCancel:()=>d(!1),width:800,children:[e.jsx(We,{message:`当前策略: ${(c==null?void 0:c.name)||g}`,description:(c==null?void 0:c.description)||"策略参数配置",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(H,{layout:"vertical",children:[t.length>0?e.jsx(pe,{gutter:16,children:t.map((s,i)=>e.jsx(b,{span:12,children:e.jsx(H.Item,{label:`${s.parameter_name}${s.description?` (${s.description})`:""}`,help:s.description,children:s.parameter_type==="int"?e.jsx(ft,{value:N[s.parameter_name]||s.min_value,onChange:_=>T(P=>Ut(Wt({},P),{[s.parameter_name]:_})),min:s.min_value,max:s.max_value,step:s.step_size,style:{width:"100%"}}):s.parameter_type==="float"?e.jsx(ft,{value:N[s.parameter_name]||s.min_value,onChange:_=>T(P=>Ut(Wt({},P),{[s.parameter_name]:_})),min:s.min_value,max:s.max_value,step:s.step_size,precision:2,style:{width:"100%"}}):e.jsx(Be,{value:N[s.parameter_name]||"",onChange:_=>T(P=>Ut(Wt({},P),{[s.parameter_name]:_.target.value})),placeholder:`请输入${s.parameter_name}`})})},s.parameter_name))}):e.jsx(We,{message:"暂无参数配置",description:"该策略暂未配置参数空间，将使用默认参数进行回测",type:"warning",showIcon:!0}),t.length>0&&e.jsx(We,{message:"参数说明",description:e.jsx("div",{children:t.map((s,i)=>e.jsxs("p",{children:[e.jsxs("strong",{children:[s.parameter_name,"："]}),s.description,s.parameter_type==="int"||s.parameter_type==="float"?` (范围: ${s.min_value} - ${s.max_value}, 步长: ${s.step_size})`:""]},i))}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs($e,{children:[e.jsx(M,{onClick:ya,children:"重置默认值"}),e.jsx(M,{type:"dashed",onClick:ja,children:"从优化导入"})]})]})]}),e.jsxs(ke,{title:"选择优化结果",open:A,onCancel:()=>z(!1),width:800,footer:null,children:[e.jsx(We,{message:"选择要导入的优化结果",description:"以下是从参数优化中获得的最佳参数配置，按优化得分排序",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{maxHeight:400,overflowY:"auto"},children:ge.map((s,i)=>{var _;return e.jsxs(ce,{size:"small",style:{marginBottom:8},hoverable:!0,onClick:()=>ba(s),children:[e.jsxs(pe,{gutter:16,align:"middle",children:[e.jsx(b,{span:16,children:e.jsxs("div",{children:[e.jsx("strong",{children:s.job_name}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:4},children:[s.description&&`${s.description} • `,"完成时间: ",s.completed_at?new Date(s.completed_at).toLocaleString():"未知"]})]})}),e.jsx(b,{span:4,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",color:"#1890ff"},children:(_=s.best_score)==null?void 0:_.toFixed(4)}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:s.objective_function})]})}),e.jsx(b,{span:4,children:e.jsx("div",{style:{textAlign:"center"},children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:["试验次数: ",s.total_trials]})})})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsx("strong",{children:"关键参数:"}),e.jsxs("div",{style:{marginTop:4,maxHeight:"40px",overflow:"hidden"},children:[Object.entries(s.best_parameters||{}).slice(0,3).map(([P,se])=>e.jsxs(be,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[P==="short_window"?"短期":P==="long_window"?"长期":P==="min_reversal_points"?"反转点":P==="lookback_period"?"回望期":P==="signal_strength_threshold"?"信号阈值":P==="batch_count"?"批次数":P==="stop_loss_ratio"?"止损":P==="take_profit_ratio"?"止盈":P,": ",typeof se=="number"?se.toFixed(1):String(se)]},P)),Object.keys(s.best_parameters||{}).length>3&&e.jsxs(be,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",Object.keys(s.best_parameters||{}).length-3,"个"]})]})]})]},s.job_id)})}),ge.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},children:"暂无优化结果"})]})]})},en=o.memo(Xr);var tn=Object.defineProperty,sn=Object.defineProperties,an=Object.getOwnPropertyDescriptors,Ns=Object.getOwnPropertySymbols,rn=Object.prototype.hasOwnProperty,nn=Object.prototype.propertyIsEnumerable,Ts=(r,a,n)=>a in r?tn(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,Gt=(r,a)=>{for(var n in a||(a={}))rn.call(a,n)&&Ts(r,n,a[n]);if(Ns)for(var n of Ns(a))nn.call(a,n)&&Ts(r,n,a[n]);return r},Fs=(r,a)=>sn(r,an(a)),it=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const{Title:on,Text:ze}=xt,{Option:bt}=et,{TabPane:Os}=Tt,ln=()=>{const[r,a]=o.useState([]),[n,f]=o.useState(null),[u,x]=o.useState([]),[w,$]=o.useState([]),[h,v]=o.useState(!1),F=o.useRef(!1),[J]=H.useForm(),[y,he]=o.useState(!1),[ve,re]=o.useState(!1),[W,ne]=o.useState(!1),[g,E]=o.useState(null),[C,Se]=o.useState(null),[xe,U]=o.useState(!1),[Ce,Ye]=o.useState([]),[q,Le]=o.useState({}),[X,Me]=o.useState([]),[Ee,Ne]=o.useState(!1),Ue=o.useCallback(()=>{const t=r.find(z=>z.id===n),l=(t==null?void 0:t.name)||"策略优化",j=J.getFieldsValue().symbol||"AAPL",A=B().format("YYYYMMDD");return`${l}_${j}_${A}`},[n,r,J]),Ge=o.useCallback(()=>{if(!Ee){const t=Ue();J.setFieldValue("name",t)}},[Ee,Ue,J]),O=()=>it(void 0,null,function*(){try{const t=yield K.get("/api/strategies");t.data&&t.data.data&&a(t.data.data)}catch(t){console.error("加载策略列表失败:",t),m.error("加载策略列表失败")}}),R=()=>it(void 0,null,function*(){try{const t=yield K.get("/api/data/stocks");if(t.data&&Array.isArray(t.data)){const l=t.data.map(c=>({symbol:c.symbol,name:c.name}));Me(l)}}catch(t){console.error("加载股票列表失败:",t),Me([{symbol:"AAPL",name:"Apple Inc."},{symbol:"TSLA",name:"Tesla Inc."},{symbol:"MSFT",name:"Microsoft Corporation"},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"AMZN",name:"Amazon.com Inc."}])}}),G=t=>it(void 0,null,function*(){try{const l=yield K.get(`/api/data/stock/symbol/${t}/date-range`);if(l.data&&l.data.status==="success"){const{min_date:c,max_date:j}=l.data.data;Le({min_date:c,max_date:j}),c&&j&&J.setFieldsValue({start_date:B(c),end_date:B(j)})}}catch(l){console.error("获取股票数据范围失败:",l)}}),ee=t=>{const l=B();let c,j=l;switch(t){case"recent1y":c=l.subtract(1,"year");break;case"recent3y":c=l.subtract(3,"year");break;case"recent5y":c=l.subtract(5,"year");break;case"recent6y":c=l.subtract(6,"year");break;case"recent7y":c=l.subtract(7,"year");break;case"recent8y":c=l.subtract(8,"year");break;case"recent9y":c=l.subtract(9,"year");break;case"recent10y":c=l.subtract(10,"year");break;case"full":q.min_date&&q.max_date?(c=B(q.min_date),j=B(q.max_date)):c=l.subtract(5,"year");break;default:c=l.subtract(1,"year")}J.setFieldsValue({start_date:c,end_date:j})},Te=t=>it(void 0,null,function*(){try{const l=yield K.get(`/api/optimization/strategies/${t}/parameter-spaces`);l.data&&l.data.status==="success"&&x(l.data.data)}catch(l){console.error("加载参数空间失败:",l)}}),le=t=>it(void 0,null,function*(){var l;try{const c=t?{strategy_id:t}:{},j=yield K.get("/api/optimization/jobs",{params:c});if(j.data&&j.data.status==="success"){const A=Array.isArray((l=j.data.data)==null?void 0:l.jobs)?j.data.data.jobs:[];$(A)}else $([])}catch(c){console.error("加载优化任务失败:",c),$([])}}),Fe=t=>{f(t),Te(t),le(t)},tt=()=>{x([...u,{parameter_name:"",parameter_type:"float",min_value:0,max_value:1,step_size:.1,description:""}])},kt=t=>{x(u.filter((l,c)=>c!==t))},He=(t,l,c)=>{const j=[...u];j[t]=Fs(Gt({},j[t]),{[l]:c}),x(j)},nt=()=>it(void 0,null,function*(){if(!n){m.error("请先选择策略");return}try{v(!0),yield K.post(`/api/optimization/strategies/${n}/parameter-spaces`,u),m.success("参数空间保存成功"),he(!1)}catch(t){console.error("保存参数空间失败:",t),m.error("保存参数空间失败")}finally{v(!1)}}),gt=t=>it(void 0,null,function*(){try{v(!0),E(t),console.log("🔍 开始获取试验列表:",t.name);const l=performance.now();try{console.log("📊 尝试获取轻量级试验摘要...");const z=yield K.get(`/api/optimization/jobs/${t.id}/trials-summary`),ge=performance.now();if(console.log(`✅ 轻量级试验摘要耗时: ${(ge-l).toFixed(0)}ms`),z.data&&z.data.status==="success"){console.log(`📊 获取到 ${z.data.data.length} 个试验摘要`),Ye(z.data.data),U(!0);return}}catch(z){console.warn("⚠️ 轻量级摘要API失败，使用完整数据:",z)}console.log("📋 获取完整试验数据...");const c=performance.now(),j=yield K.get(`/api/optimization/jobs/${t.id}/trials`),A=performance.now();console.log(`📊 完整试验数据耗时: ${(A-c).toFixed(0)}ms`),j.data&&j.data.status==="success"?(console.log(`📊 获取到 ${j.data.data.length} 个完整试验结果`),Ye(j.data.data),U(!0)):m.error("获取试验数据失败")}catch(l){console.error("获取试验数据失败:",l),m.error("获取试验数据失败")}finally{v(!1)}}),N=(t,l=!1)=>it(void 0,null,function*(){var c,j;try{if(t.status==="running"&&!l){m.error("运行中的任务不能删除，请先停止任务");return}const A=l?`/api/optimization/jobs/${t.id}?force=true`:`/api/optimization/jobs/${t.id}`,z=yield K.delete(A);z.data&&z.data.status==="success"?(m.success(z.data.message||"删除成功"),yield le()):m.error("删除失败")}catch(A){console.error("删除优化任务失败:",A);const z=((j=(c=A.response)==null?void 0:c.data)==null?void 0:j.detail)||A.message||"删除失败";m.error(z)}}),T=t=>it(void 0,null,function*(){try{v(!0),E(t),console.log("🚀 开始获取任务详情:",t.name);const l=performance.now();if(t.best_parameters&&t.status==="completed"&&t.optimization_config){try{console.log("📊 尝试获取轻量级性能指标...");const te=yield K.get(`/api/optimization/jobs/${t.id}/best-performance`);if(te.data&&te.data.status==="success"){const D=performance.now();console.log(`✅ 使用轻量级API，耗时: ${(D-l).toFixed(0)}ms`);const Q=te.data.data,De={total_return:Q.total_return,annual_return:Q.annual_return,sharpe_ratio:Q.sharpe_ratio,max_drawdown:Q.max_drawdown,win_rate:Q.win_rate,profit_factor:Q.profit_factor,alpha:Q.alpha,beta:Q.beta,total_trades:Q.total_trades,parameters:Q.parameters,fromOptimization:!0,isLightweight:!0};Se(De),ne(!0),v(!1);return}}catch(te){console.warn("⚠️ 轻量级API失败，尝试完整数据:",te)}try{console.log("📊 尝试获取完整回测结果...");const te=yield K.get(`/api/optimization/jobs/${t.id}/trials`);if(te.data&&te.data.status==="success"&&te.data.data.length>0){const D=te.data.data[0];if(D.backtest_results){const Q=performance.now();console.log(`✅ 使用完整缓存结果，耗时: ${(Q-l).toFixed(0)}ms`);const De=Fs(Gt({},D.backtest_results),{fromOptimization:!0});Se(De),ne(!0),v(!1);return}else console.warn("⚠️ 最佳试验没有缓存的回测结果")}}catch(te){console.warn("❌ 无法获取优化试验数据，将重新运行回测:",te)}console.log("🔄 缓存未命中，重新运行回测...");const c=performance.now(),j=t.optimization_config.backtest_config,A={strategy_id:t.strategy_id,parameters:t.best_parameters,symbol:j.symbol,start_date:j.start_date,end_date:j.end_date,initial_capital:j.initial_capital};console.log("📋 回测请求参数:",A);const z=yield K.post("/api/strategies/backtest",A),ge=performance.now();console.log(`⏱️ 重新回测耗时: ${(ge-c).toFixed(0)}ms`),z.data&&z.data.status==="success"?Se(z.data.data):(console.error("回测失败:",z.data),m.error("回测失败，无法获取详细结果"))}else t.status==="completed"&&m.warning("优化配置信息不完整，无法重现回测结果");ne(!0)}catch(l){console.error("获取任务详情失败:",l),m.error("获取任务详情失败")}finally{v(!1)}}),ie=t=>it(void 0,null,function*(){if(!n){m.error("请先选择策略");return}if(u.length===0){m.error("请先配置参数空间");return}try{v(!0);const l={strategy_id:n,name:t.name,description:t.description,parameter_spaces:u,objective_function:t.objective_function,n_trials:t.n_trials,timeout:t.timeout,backtest_config:{symbol:t.symbol,start_date:t.start_date.format("YYYY-MM-DD"),end_date:t.end_date.format("YYYY-MM-DD"),initial_capital:t.initial_capital}};yield K.post("/api/optimization/optimize",l),m.success("优化任务已启动"),re(!1),J.resetFields(),le(n)}catch(l){console.error("启动优化任务失败:",l),m.error("启动优化任务失败")}finally{v(!1)}}),d=[{title:"ID",dataIndex:"id",key:"id",width:50,align:"center"},{title:"任务名称",dataIndex:"name",key:"name",width:160,ellipsis:!0},{title:"策略",dataIndex:"strategy_id",key:"strategy",width:120,ellipsis:{showTitle:!1},render:t=>{const l=r.find(c=>c.id===t);return l?e.jsx(me,{title:l.name,placement:"topLeft",children:e.jsx(be,{color:"blue",style:{margin:0,maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",cursor:"pointer"},children:l.name})}):e.jsx(ze,{type:"secondary",style:{fontSize:"12px"},children:"未知策略"})}},{title:"状态",dataIndex:"status",key:"status",width:70,align:"center",render:t=>{const c={running:{color:"processing",text:"运行中"},completed:{color:"success",text:"已完成"},failed:{color:"error",text:"失败"},cancelled:{color:"default",text:"已取消"}}[t]||{color:"default",text:t};return e.jsx(be,{color:c.color,children:c.text})}},{title:"进度",dataIndex:"progress",key:"progress",width:90,render:(t,l)=>{const c=`${l.completed_trials}/${l.total_trials}`,j=`${t.toFixed(1)}%`;return e.jsx(me,{title:e.jsxs("div",{children:[e.jsxs("div",{children:["已完成试验: ",l.completed_trials]}),e.jsxs("div",{children:["总试验数: ",l.total_trials]}),e.jsxs("div",{children:["完成进度: ",t.toFixed(1),"%"]})]}),placement:"topLeft",children:e.jsxs("div",{style:{width:"80px",textAlign:"center"},children:[e.jsx(Wa,{percent:t,size:"small",style:{marginBottom:"1px"},showInfo:!1}),e.jsxs("div",{style:{fontSize:"10px",color:"#666",lineHeight:"1.2"},children:[c," (",j,")"]})]})})}},{title:"最佳得分",dataIndex:"best_score",key:"best_score",width:100,align:"center",render:(t,l)=>{if(!t)return"-";const j={sharpe_ratio:"夏普比率",total_return:"总收益率",annual_return:"年化收益率"}[l.objective_function]||"得分";return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",color:"#1890ff"},children:t.toFixed(4)}),e.jsx(ze,{type:"secondary",style:{fontSize:"11px"},children:j})]})}},{title:"交易配置",dataIndex:"optimization_config",key:"trading_config",width:110,align:"center",render:t=>{if(!t||!t.backtest_config)return"-";const{symbol:l,initial_capital:c}=t.backtest_config;return e.jsxs("div",{children:[e.jsx(be,{color:"green",style:{marginBottom:"2px"},children:l}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["¥",(c==null?void 0:c.toLocaleString())||"N/A"]})]})}},{title:"回测时间段",dataIndex:"optimization_config",key:"date_range",width:140,render:t=>{if(!t||!t.backtest_config)return"-";const{start_date:l,end_date:c}=t.backtest_config;return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:l}),e.jsx("div",{style:{fontSize:"10px",color:"#999",margin:"2px 0"},children:"至"}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:c})]})}},{title:"最佳参数",dataIndex:"best_parameters",key:"best_parameters",width:200,render:t=>{if(!t)return"-";const l=Object.entries(t),c=3,j=l.slice(0,c),A=l.length-c;return e.jsxs("div",{style:{maxHeight:"60px",overflow:"hidden"},children:[j.map(([z,ge])=>e.jsxs(be,{color:"blue",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[z==="short_window"?"短期":z==="long_window"?"长期":z==="min_reversal_points"?"反转点":z==="lookback_period"?"回望期":z==="signal_strength_threshold"?"信号阈值":z==="batch_count"?"批次数":z==="stop_loss_ratio"?"止损":z==="take_profit_ratio"?"止盈":z,": ",typeof ge=="number"?ge.toFixed(2):ge]},z)),A>0&&e.jsxs(be,{color:"default",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",A,"个"]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:140,render:t=>e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px"},children:B(t).format("YYYY-MM-DD")}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:B(t).format("HH:mm:ss")})]})},{title:"操作",key:"action",width:100,align:"center",render:(t,l)=>{const c=l.status==="running"&&B().diff(B(l.created_at),"hour")>=1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(M,{type:"link",icon:e.jsx(us,{}),onClick:()=>T(l),size:"small",disabled:l.status!=="completed",style:{padding:"2px 8px",height:"auto",fontSize:"12px"},children:"查看回测"}),e.jsx(M,{type:"link",onClick:()=>gt(l),size:"small",disabled:l.status!=="completed",style:{color:"#1890ff",padding:"2px 8px",height:"auto",fontSize:"12px"},children:"其他回测"}),e.jsx(Ua,{title:"确认删除",description:c?`检测到异常状态，确定要删除优化任务 "${l.name}" 吗？此操作不可恢复。`:`确定要删除优化任务 "${l.name}" 吗？此操作不可恢复。`,onConfirm:()=>N(l,c),okText:"确定",cancelText:"取消",disabled:l.status==="running"&&!c,placement:"top",children:e.jsx(M,{danger:!0,size:"small",disabled:l.status==="running"&&!c,icon:e.jsx(Nt,{}),style:Gt({padding:"2px 8px",height:"auto",fontSize:"12px"},c&&{borderColor:"#ff7875",color:"#ff7875"}),children:c?"强制删除":"删除"})})]})}}];return o.useEffect(()=>{F.current||(F.current=!0,O(),le(),R(),G("AAPL"))},[]),e.jsxs("div",{style:{padding:"16px",height:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(ce,{style:{marginBottom:"16px",flexShrink:0},children:[e.jsx(on,{level:3,style:{margin:"0 0 16px 0"},children:"策略参数优化"}),e.jsxs(pe,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(b,{span:8,children:e.jsx(et,{placeholder:"选择策略",style:{width:"100%"},value:n,onChange:Fe,children:r.map(t=>e.jsx(bt,{value:t.id,children:t.name},t.id))})}),e.jsx(b,{span:16,children:e.jsxs($e,{children:[e.jsx(M,{icon:e.jsx(Kt,{}),onClick:()=>he(!0),disabled:!n,children:"配置参数空间"}),e.jsx(M,{type:"primary",icon:e.jsx(Et,{}),onClick:()=>{re(!0),Ne(!1),setTimeout(()=>Ge(),100)},disabled:!n||u.length===0,children:"启动优化"}),e.jsx(M,{icon:e.jsx(ds,{}),onClick:()=>{n&&le(n)},children:"刷新"})]})})]})]}),e.jsx(ce,{title:"优化任务列表",style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},styles:{body:{flex:1,padding:"16px",display:"flex",flexDirection:"column",minHeight:0}},children:e.jsx(wt,{columns:d,dataSource:w,rowKey:"id",loading:h,size:"small",scroll:{x:1200,y:"calc(100vh - 320px)"},pagination:{pageSize:Oe.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,size:"small",onChange:(t,l)=>{Oe.setCurrentPage(t),Oe.setPageSize(l||20)},onShowSizeChange:(t,l)=>{Oe.setPageSize(l)}},style:{flex:1}})}),e.jsxs(ke,{title:"配置参数空间",open:y,onOk:nt,onCancel:()=>he(!1),width:900,confirmLoading:h,children:[e.jsx(We,{message:"MA交叉策略参数优化指南",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"short_window"}),": 短期移动平均线周期，建议范围 3-15天"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"long_window"}),": 长期移动平均线周期，建议范围 10-60天"]}),e.jsx("p",{children:"注意：短期周期必须小于长期周期"})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(M,{type:"dashed",onClick:tt,icon:e.jsx(Qs,{}),block:!0,children:"添加参数"})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx($e,{children:e.jsx(M,{type:"link",onClick:()=>{x([{parameter_name:"short_window",parameter_type:"int",min_value:3,max_value:15,step_size:1,description:"短期移动平均线周期"},{parameter_name:"long_window",parameter_type:"int",min_value:10,max_value:60,step_size:5,description:"长期移动平均线周期"}])},children:"📊 使用MA策略推荐配置"})})}),u.map((t,l)=>e.jsx(ce,{size:"small",style:{marginBottom:"8px"},children:e.jsxs(pe,{gutter:[8,8],children:[e.jsx(b,{span:4,children:e.jsx(Be,{placeholder:"参数名",value:t.parameter_name,onChange:c=>He(l,"parameter_name",c.target.value)})}),e.jsx(b,{span:3,children:e.jsxs(et,{value:t.parameter_type,onChange:c=>He(l,"parameter_type",c),style:{width:"100%"},children:[e.jsx(bt,{value:"int",children:"整数"}),e.jsx(bt,{value:"float",children:"小数"}),e.jsx(bt,{value:"choice",children:"选择"})]})}),t.parameter_type!=="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{span:3,children:e.jsx(ft,{placeholder:"最小值",value:t.min_value,onChange:c=>He(l,"min_value",c),style:{width:"100%"}})}),e.jsx(b,{span:3,children:e.jsx(ft,{placeholder:"最大值",value:t.max_value,onChange:c=>He(l,"max_value",c),style:{width:"100%"}})})]}),e.jsx(b,{span:4,children:e.jsx(Be,{placeholder:"描述",value:t.description,onChange:c=>He(l,"description",c.target.value)})}),e.jsx(b,{span:2,children:e.jsx(M,{type:"text",danger:!0,icon:e.jsx(Nt,{}),onClick:()=>kt(l)})})]})},l))]}),e.jsxs(ke,{title:"启动参数优化",open:ve,onOk:()=>J.submit(),onCancel:()=>re(!1),width:700,confirmLoading:h,children:[e.jsx(We,{message:"优化说明",description:"系统将自动测试不同参数组合，找到最优的策略参数。建议先用较少试验次数快速测试。",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(H,{form:J,onFinish:ie,layout:"vertical",children:[e.jsx(H.Item,{name:"name",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(Be,{placeholder:"如: MA策略优化_AAPL_20240101",onChange:t=>{t.target.value!==Ue()?Ne(!0):Ne(!1)}})}),e.jsx(H.Item,{name:"description",label:"任务描述",children:e.jsx(Be.TextArea,{placeholder:"描述此次优化的目的和预期...",rows:2})}),e.jsxs(pe,{gutter:[16,16],children:[e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"objective_function",label:"优化目标",initialValue:"sharpe_ratio",children:e.jsxs(et,{children:[e.jsx(bt,{value:"sharpe_ratio",children:"夏普比率 (推荐)"}),e.jsx(bt,{value:"total_return",children:"总收益率"}),e.jsx(bt,{value:"annual_return",children:"年化收益率"})]})})}),e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"n_trials",label:"试验次数",initialValue:50,extra:"建议: 快速测试50次，详细优化100-200次",children:e.jsx(ft,{min:10,max:1e3,style:{width:"100%"}})})})]}),e.jsxs(pe,{gutter:[16,16],children:[e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"symbol",label:"交易品种",rules:[{required:!0,message:"请选择交易品种"}],initialValue:"AAPL",children:e.jsx(et,{placeholder:"选择股票代码",showSearch:!0,filterOption:(t,l)=>{var c,j;return((c=l==null?void 0:l.label)!=null?c:"").toLowerCase().includes(t.toLowerCase())||((j=l==null?void 0:l.value)!=null?j:"").toLowerCase().includes(t.toLowerCase())},onChange:t=>{t&&(G(t),Ge())},options:X.map(t=>({value:t.symbol,label:`${t.symbol} - ${t.name}`}))})})}),e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"initial_capital",label:"初始资金",initialValue:1e5,children:e.jsx(ft,{min:1e3,style:{width:"100%"},formatter:t=>`¥ ${t}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t==null?void 0:t.replace(/¥\s?|(,*)/g,"")})})})]}),e.jsx(H.Item,{label:"快捷时间选择",children:e.jsxs($e,{wrap:!0,children:[e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent1y"),children:"最近1年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent3y"),children:"最近3年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent5y"),children:"最近5年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent6y"),children:"最近6年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent7y"),children:"最近7年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent8y"),children:"最近8年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent9y"),children:"最近9年"}),e.jsx(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("recent10y"),children:"最近10年"}),q.min_date&&q.max_date&&e.jsxs(M,{size:"small",icon:e.jsx(mt,{}),onClick:()=>ee("full"),type:"primary",children:["全部数据 (",q.min_date," ~ ",q.max_date,")"]})]})}),e.jsxs(pe,{gutter:[16,16],children:[e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],initialValue:B("2023-01-01"),children:e.jsx(Bt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择开始日期"})})}),e.jsx(b,{span:12,children:e.jsx(H.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],initialValue:B("2024-12-31"),children:e.jsx(Bt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择结束日期"})})})]}),e.jsx(We,{message:"注意事项",description:e.jsxs("ul",{style:{margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"确保已配置参数空间"}),e.jsx("li",{children:"优化过程可能需要几分钟到几小时"}),e.jsx("li",{children:"可以在任务列表中查看进度"})]}),type:"warning",showIcon:!0})]})]}),e.jsx(ke,{title:"优化任务详情",open:W,onCancel:()=>{ne(!1),E(null),Se(null)},footer:null,width:1e3,children:g&&e.jsxs("div",{children:[e.jsx(We,{message:`任务状态: ${g.status==="completed"?"已完成":g.status}`,type:g.status==="completed"?"success":"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(Tt,{defaultActiveKey:"1",children:[e.jsxs(Os,{tab:"基本信息",children:[e.jsxs(pe,{gutter:[16,16],children:[e.jsxs(b,{span:12,children:[e.jsx(ze,{strong:!0,children:"任务名称: "}),e.jsx(ze,{children:g.name})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{strong:!0,children:"优化目标: "}),e.jsx(ze,{children:g.objective_function==="sharpe_ratio"?"夏普比率":g.objective_function==="total_return"?"总收益率":g.objective_function==="annual_return"?"年化收益率":"未知"})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{strong:!0,children:"试验次数: "}),e.jsxs(ze,{children:[g.completed_trials,"/",g.total_trials]})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{strong:!0,children:"最佳得分: "}),e.jsx(ze,{children:g.best_score?g.best_score.toFixed(4):"-"})]})]}),g.optimization_config&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(ze,{strong:!0,children:"回测配置:"}),e.jsxs(pe,{gutter:[16,8],style:{marginTop:"8px"},children:[e.jsxs(b,{span:12,children:[e.jsx(ze,{type:"secondary",children:"交易品种: "}),e.jsx(be,{color:"green",children:g.optimization_config.backtest_config.symbol})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{type:"secondary",children:"初始资金: "}),e.jsxs(be,{color:"blue",children:["¥",g.optimization_config.backtest_config.initial_capital.toLocaleString()]})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{type:"secondary",children:"开始日期: "}),e.jsx(be,{children:g.optimization_config.backtest_config.start_date})]}),e.jsxs(b,{span:12,children:[e.jsx(ze,{type:"secondary",children:"结束日期: "}),e.jsx(be,{children:g.optimization_config.backtest_config.end_date})]})]})]}),g.best_parameters&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(ze,{strong:!0,children:"最优参数组合:"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"120px",overflowY:"auto"},children:Object.entries(g.best_parameters).map(([t,l])=>e.jsxs(be,{color:"blue",style:{marginBottom:"4px",marginRight:"4px",fontSize:"11px",padding:"2px 6px"},children:[t==="short_window"?"短期均线":t==="long_window"?"长期均线":t==="min_reversal_points"?"反转点数":t==="lookback_period"?"回望周期":t==="min_price_change"?"最小价格变化":t==="signal_strength_threshold"?"信号强度阈值":t==="max_trading_range"?"最大交易范围":t==="batch_count"?"分批次数":t==="batch_interval"?"分批间隔":t==="position_size_per_batch"?"分批仓位":t==="stop_loss_ratio"?"止损比例":t==="take_profit_ratio"?"止盈比例":t==="rsi_oversold"?"RSI超卖":t==="rsi_overbought"?"RSI超买":t==="volume_threshold"?"成交量阈值":t==="max_extremums"?"最大极值点":t==="min_extremum_distance"?"极值点距离":t,": ",typeof l=="number"?l.toFixed(2):l]},t))})]})]},"1"),e.jsx(Os,{tab:"回测结果",children:C?e.jsxs("div",{children:[e.jsxs(pe,{gutter:[16,16],children:[e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"总收益率",value:C.total_return*100,precision:2,suffix:"%",valueStyle:{color:C.total_return>=0?"#3f8600":"#cf1322"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"年化收益率",value:C.annual_return*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"最大回撤",value:C.max_drawdown*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"夏普比率",value:C.sharpe_ratio,precision:3,valueStyle:{color:C.sharpe_ratio>=1?"#3f8600":"#cf1322"}})})})]}),e.jsxs(pe,{gutter:[16,16],style:{marginTop:"16px"},children:[e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"胜率",value:C.win_rate*100,precision:2,suffix:"%",valueStyle:{color:C.win_rate>=.5?"#3f8600":"#cf1322"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"盈亏比",value:C.profit_factor,precision:2,valueStyle:{color:C.profit_factor>=1?"#3f8600":"#cf1322"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"交易次数",value:C.trades?C.trades.length:0,valueStyle:{color:"#1890ff"}})})}),e.jsx(b,{span:6,children:e.jsx(ce,{size:"small",children:e.jsx(de,{title:"Alpha",value:C.alpha,precision:4,valueStyle:{color:C.alpha>=0?"#3f8600":"#cf1322"}})})})]}),e.jsx(We,{message:"参数说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"夏普比率"}),": 风险调整后收益，",">"," 1.0为优秀，",">"," 2.0为卓越"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"胜率"}),": 盈利交易占总交易的比例，",">"," 50%为良好"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏比"}),": 平均盈利/平均亏损，",">"," 1.0表示盈利大于亏损"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alpha"}),": 相对于市场的超额收益，",">"," 0表示跑赢市场"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(ze,{type:"secondary",children:"加载回测结果中..."})})},"2")]})]})}),e.jsx(ke,{title:"所有回测试验结果",open:xe,onCancel:()=>{U(!1),Ye([]),E(null)},footer:null,width:1e3,children:g&&e.jsxs("div",{children:[e.jsx(We,{message:`任务: ${g.name} - 共${Ce.length}个试验，按得分降序排列`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx(wt,{dataSource:Ce,rowKey:t=>t.id||t.trial_number||Math.random(),pagination:!1,size:"small",scroll:{y:400},columns:[{title:"排名",key:"rank",width:60,render:(t,l,c)=>{const j=l.rank||c+1;return e.jsx(be,{color:j===1?"gold":j===2?"silver":j===3?"orange":"default",children:j})}},{title:"得分",dataIndex:"objective_value",key:"objective_value",width:100,render:t=>e.jsx(ze,{strong:!0,style:{color:"#1890ff"},children:t?t.toFixed(4):"-"}),sorter:(t,l)=>(t.objective_value||0)-(l.objective_value||0),defaultSortOrder:"descend"},{title:"参数组合",dataIndex:"parameters",key:"parameters",width:200,render:t=>e.jsx("div",{children:Object.entries(t||{}).map(([l,c])=>e.jsxs(be,{color:"blue",style:{marginBottom:"2px"},children:[l==="short_window"?"短期":l==="long_window"?"长期":l,": ",c]},l))})},{title:"年化收益",dataIndex:"annual_return",key:"annual_return",width:90,render:t=>{if(t==null)return"-";const l=t>=0?"#3f8600":"#cf1322";return e.jsxs(ze,{style:{color:l,fontWeight:"bold"},children:[(t*100).toFixed(1),"%"]})}},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",width:90,render:t=>t==null?"-":e.jsxs(ze,{style:{color:"#3f8600",fontWeight:"bold"},children:[(Math.abs(t)*100).toFixed(1),"%"]})},{title:"交易次数",dataIndex:"total_trades",key:"total_trades",width:80,render:t=>e.jsx(ze,{type:"secondary",children:t||0})},{title:"执行时间",dataIndex:"execution_time",key:"execution_time",width:80,render:t=>e.jsx(ze,{type:"secondary",children:t?`${(t*1e3).toFixed(0)}ms`:"-"})},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:150,render:t=>t?B(t).format("HH:mm:ss"):"-"}]}),e.jsx(We,{message:"说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"排名"}),": 按优化目标得分排序，金牌为最佳结果"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"得分"}),": ",g.objective_function==="sharpe_ratio"?"夏普比率":g.objective_function==="total_return"?"总收益率":g.objective_function==="annual_return"?"年化收益率":"优化目标","得分"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"参数组合"}),": 该试验使用的策略参数"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]})})]})},cn=o.memo(ln);var Ys=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const{Title:dn,Text:Zt}=xt,un=()=>{const r=St(),[a,n]=o.useState([]),[f,u]=o.useState(!1),x=o.useRef(!1),w=()=>Ys(void 0,null,function*(){u(!0);try{const y=yield Lt();console.log("获取到的策略数据:",y),n(y)}catch{m.error("获取策略列表失败")}finally{u(!1)}});o.useEffect(()=>{x.current||(x.current=!0,w())},[]);const $=()=>{r("/strategy/edit")},h=y=>{y&&r(`/strategy/edit/${y}`)},v=y=>Ys(void 0,null,function*(){if(y)try{yield ra(y),m.success("策略删除成功"),w()}catch{m.error("删除策略失败")}}),F=y=>{y&&r(`/backtest?strategy=${y}`)},J=()=>f?e.jsx(Ct,{tip:"加载中..."}):a.length===0?e.jsx(js,{description:"暂无策略",image:js.PRESENTED_IMAGE_SIMPLE}):e.jsx(Xe,{className:"strategy-list",itemLayout:"horizontal",dataSource:a,renderItem:y=>e.jsxs(Xe.Item,{className:"strategy-list-item",style:{padding:"16px",borderRadius:"8px",backgroundColor:"#f9f9f9",marginBottom:"12px",display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{flex:1,overflow:"hidden"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:e.jsx(Zt,{strong:!0,style:{fontSize:"16px",marginRight:"8px"},children:y.name})}),e.jsx(Zt,{type:"secondary",style:{display:"block",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:y.description||"无描述"}),y.updated_at&&e.jsxs(Zt,{type:"secondary",style:{fontSize:"12px"},children:["最后更新: ",new Date(y.updated_at).toLocaleString()]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center"},children:e.jsxs($e,{children:[e.jsx(M,{type:"primary",icon:e.jsx(Ga,{}),onClick:()=>F(y.id),children:"回测"}),e.jsx(M,{icon:e.jsx(Za,{}),onClick:()=>h(y.id),children:"编辑"}),e.jsx(M,{danger:!0,icon:e.jsx(Nt,{}),onClick:()=>v(y.id),children:"删除"})]})})]},y.id)});return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(ce,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx(dn,{level:4,style:{margin:0},children:"策略构建器"}),e.jsx(M,{type:"primary",icon:e.jsx(Qs,{}),onClick:$,children:"创建新策略"})]}),e.jsx(qt,{}),J()]})})};var Jt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});const{Title:pn,Text:Qt}=xt,{TextArea:hn}=Be,Rs=()=>{const{id:r}=Vs(),a=St(),[n]=H.useForm(),[f,u]=o.useState(""),[x,w]=o.useState(!1),[$,h]=o.useState(!1),[v,F]=o.useState(!0),[J,y]=o.useState(""),he=`from .strategy_template import StrategyTemplate
import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

class MyStrategy(StrategyTemplate):
    """
    我的自定义策略
    """
    
    def __init__(self, parameters=None):
        """初始化策略"""
        default_params = {
            # 在这里定义策略参数和默认值
        }
        
        # 合并用户参数与默认参数
        if parameters:
            default_params.update(parameters)
            
        super().__init__("我的策略", default_params)
        
    def generate_signals(self) -> pd.DataFrame:
        """
        生成交易信号
        
        Returns:
            包含信号的DataFrame，包括:
            - signal: 交易信号 (1: 买入, -1: 卖出, 0: 不操作)
            - trigger_reason: 信号触发原因
        """
        if self.data is None or self.data.empty:
            logger.warning("未设置数据或数据为空，无法生成信号")
            return pd.DataFrame()
        
        # 获取数据
        df = self.data.copy()
        
        # 添加交易信号
        df['signal'] = 0
        df['trigger_reason'] = ''
        
        # TODO: 实现您的交易逻辑
        
        # 使用log函数记录策略执行过程（可选）
        self.log("开始生成交易信号", "INFO")
        self.log(f"数据行数: {len(df)}", "DEBUG")
        
        # 示例: 当价格上涨超过2%时买入
        price_change = df['close'].pct_change() * 100
        buy_signal = price_change > 2
        df.loc[buy_signal, 'signal'] = 1
        df.loc[buy_signal, 'trigger_reason'] = "价格上涨超过2%"
        
        # 记录买入信号数量
        buy_count = buy_signal.sum()
        if buy_count > 0:
            self.log(f"生成买入信号 {buy_count} 个", "INFO")
        
        # 示例: 当价格下跌超过2%时卖出
        sell_signal = price_change < -2
        df.loc[sell_signal, 'signal'] = -1
        df.loc[sell_signal, 'trigger_reason'] = "价格下跌超过2%"
        
        # 记录卖出信号数量
        sell_count = sell_signal.sum()
        if sell_count > 0:
            self.log(f"生成卖出信号 {sell_count} 个", "INFO")
        
        self.log("交易信号生成完成", "INFO")
        
        return df
`;o.useEffect(()=>{r?(F(!1),ve(parseInt(r))):u(he)},[r]);const ve=g=>Jt(void 0,null,function*(){w(!0);try{const E=yield Or(g);E&&(n.setFieldsValue({name:E.name,description:E.description,parameters:E.parameters||{}}),u(E.code||he),y(E.template||""))}catch{m.error("获取策略详情失败")}finally{w(!1)}}),re=()=>Jt(void 0,null,function*(){try{const g=yield n.validateFields();w(!0);const E=g.parameters&&typeof g.parameters=="object"?g.parameters:{},C={name:g.name,description:g.description,code:f,parameters:E,template:J};let Se;v?Se=yield Yr(C):r&&(Se=yield Rr(parseInt(r),C)),Se&&(m.success(`策略${v?"创建":"更新"}成功`),v&&Se.id&&(a(`/strategy/edit/${Se.id}`),F(!1)))}catch(g){g.message?m.error(g.message):m.error(`策略${v?"创建":"更新"}失败`)}finally{w(!1)}}),W=()=>Jt(void 0,null,function*(){h(!0);try{const g=n.getFieldsValue(),E=g.parameters&&typeof g.parameters=="object"?g.parameters:{},C=yield Br(f,[],E);C&&!C.error?ke.success({title:"策略代码验证通过",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码语法正确，可以正常运行。"}),C.signals&&e.jsxs("p",{children:["测试生成了 ",C.signals.length," 条数据记录。"]})]})}):ke.error({title:"策略代码验证失败",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码存在问题，详细错误信息："}),e.jsx("pre",{style:{maxHeight:"300px",overflow:"auto"},children:C.error||"未知错误"})]})})}catch{m.error("测试策略代码失败")}finally{h(!1)}}),ne=()=>{a("/strategy")};return e.jsx("div",{style:{padding:"20px"},children:e.jsx(Ct,{spinning:x,tip:"加载中...",children:e.jsx(ce,{children:e.jsxs(pe,{gutter:[16,16],children:[e.jsx(b,{span:24,children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsxs($e,{children:[e.jsx(M,{icon:e.jsx(Xs,{}),onClick:ne,children:"返回"}),e.jsx(pn,{level:4,style:{margin:0},children:v?"创建新策略":"编辑策略"})]}),e.jsxs($e,{children:[e.jsx(M,{type:"primary",icon:e.jsx(Zs,{}),onClick:re,loading:x,children:"保存"}),e.jsx(M,{icon:e.jsx(Et,{}),onClick:W,loading:$,children:"测试"})]})]})}),e.jsx(b,{span:24,children:e.jsxs(H,{form:n,layout:"vertical",children:[e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:12,children:e.jsx(H.Item,{label:"策略名称",name:"name",rules:[{required:!0,message:"请输入策略名称"}],children:e.jsx(Be,{placeholder:"请输入策略名称"})})}),e.jsx(b,{span:12,children:e.jsx(H.Item,{label:"策略描述",name:"description",children:e.jsx(hn,{rows:1,placeholder:"请输入策略描述"})})})]}),e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"分批建仓批次数 (batch_count)",name:["parameters","batch_count"],initialValue:1,children:e.jsx(Be,{type:"number",min:1})})}),e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"批次间隔条数 (batch_interval_bars)",name:["parameters","batch_interval_bars"],initialValue:1,children:e.jsx(Be,{type:"number",min:1})})}),e.jsx(b,{span:8,children:e.jsx(H.Item,{label:"批次权重 (batch_weights)",name:["parameters","batch_weights"],tooltip:"可输入逗号分隔的数字，例如: 0.5,0.3,0.2（若为空则均分）",children:e.jsx(Be,{placeholder:"例如: 0.5,0.3,0.2 或 留空"})})})]})]})}),e.jsxs(b,{span:24,children:[e.jsx(qt,{orientation:"left",children:e.jsxs($e,{children:[e.jsx(es,{}),e.jsx(Qt,{strong:!0,children:"策略代码"})]})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(We,{message:"💡 策略日志功能",description:e.jsxs("div",{children:[e.jsxs("p",{children:["您可以在策略中使用 ",e.jsx("code",{children:"self.log(message, level)"})," 函数记录执行过程："]}),e.jsxs("ul",{style:{marginBottom:0},children:[e.jsxs("li",{children:[e.jsx("code",{children:'self.log("信息内容", "INFO")'})," - 记录一般信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("调试信息", "DEBUG")'})," - 记录调试信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("警告信息", "WARNING")'})," - 记录警告信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("错误信息", "ERROR")'})," - 记录错误信息"]})]}),e.jsx("p",{style:{marginTop:"8px",marginBottom:0},children:e.jsx(Qt,{type:"secondary",children:'日志将在回测历史的"控制台"按钮中查看，帮助您调试和监控策略执行过程。'})})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}})}),e.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:"2px"},children:e.jsx(Xa,{width:"100%",height:"600",language:"python",theme:"vs-dark",value:f,onChange:u,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,folding:!0,lineNumbers:"on",rulers:[80,120],minimap:{enabled:!0}}})}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(Qt,{type:"secondary",children:"注意：策略代码必须继承自StrategyTemplate基类，并实现generate_signals方法。"})})]})]})})})})};var vt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});ts([ss,as,rs,ns,os,ls,is,cs]);const{Title:Sn,Text:ct}=xt,Qe=r=>typeof r!="string"?String(r):r.includes("T")?r.split("T")[0]:r.includes(" ")?r.split(" ")[0]:r,mn=o.memo(()=>{var r;const a=St(),[n,f]=o.useState(!1),[u,x]=o.useState([]),[w,$]=o.useState([]),[h,v]=o.useState("all"),[F,J]=o.useState(!1),[y,he]=o.useState(null),[ve,re]=o.useState(!1),[W,ne]=o.useState("performance"),[g,E]=o.useState(0),C=o.useRef(null),Se=o.useRef(null),[xe,U]=o.useState(!1),Ce=o.useRef(!1),Ye=[{title:"日期",dataIndex:"date",key:"date",sorter:(d,t)=>{const l=new Date(d.date),c=new Date(t.date);return l.getTime()-c.getTime()}},{title:"方向",dataIndex:"action",key:"action",filters:[{text:"买入",value:"BUY"},{text:"卖出",value:"SELL"}],onFilter:(d,t)=>t.action===d,render:d=>{const t=d==="BUY"?"买入":d==="SELL"?"卖出":d;return e.jsx(be,{color:d==="BUY"?"red":"green",children:t})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:d=>e.jsx(me,{title:d||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:d||"未记录"})})},{title:"期初资金",dataIndex:"before_cash",key:"before_cash",sorter:(d,t)=>d.before_cash-t.before_cash,render:d=>(parseFloat(d)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"after_cash",key:"after_cash",sorter:(d,t)=>d.after_cash-t.after_cash,render:d=>(parseFloat(d)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"价格",dataIndex:"price",key:"price",sorter:(d,t)=>{const l=d.price||0,c=t.price||0;return l-c},render:d=>{const t=parseFloat(d);return isNaN(t)?"-":t.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(d,t)=>d.shares-t.shares,render:d=>(parseInt(d)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(d,t)=>d.value-t.value,render:d=>(parseFloat(d)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"手续费",dataIndex:"commission",key:"commission",sorter:(d,t)=>d.commission-t.commission,render:d=>(parseFloat(d)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(d,t)=>(d.position_size||0)-(t.position_size||0),render:d=>{const t=parseFloat(d)||0;return t>0?`${(t*100).toFixed(1)}%`:"-"}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(d,t)=>(d.cumulative_position_ratio||0)-(t.cumulative_position_ratio||0),render:d=>{const t=parseFloat(d)||0;return t>0?`${(t*100).toFixed(1)}%`:"-"}}],[q,Le]=o.useState(!1),[X,Me]=o.useState(null),[Ee,Ne]=o.useState(!1),[Ue]=H.useForm(),[Ge,O]=o.useState(!1),[R,G]=o.useState([]),ee=()=>vt(void 0,null,function*(){f(!0);try{const d=yield K.get("/api/backtest-status/list");x(d.data),$(d.data)}catch(d){console.error("获取回测列表失败:",d),m.error("获取回测列表失败")}finally{f(!1)}}),Te=()=>vt(void 0,null,function*(){if(u.length===0){m.warning("没有可更新的回测记录");return}ke.confirm({title:"批量更新到最新K线",content:`确定要将所有 ${u.length} 个回测记录更新到最新的K线日期吗？此操作可能需要较长时间。`,okText:"确定更新",cancelText:"取消",onOk:()=>vt(void 0,null,function*(){var d,t;U(!0);let l=0,c=0;const j=[];try{for(const A of u)try{const z=yield K.post(`/api/backtest-status/${A.id}/update`,{update_to_date:null});z.data.status==="success"?(l++,console.log(`成功更新回测: ${A.name}`)):(c++,j.push({name:A.name,error:z.data.message||"更新失败"}),console.error(`更新回测失败: ${A.name}`,z.data.message))}catch(z){c++,j.push({name:A.name,error:((t=(d=z.response)==null?void 0:d.data)==null?void 0:t.detail)||z.message||"网络错误"}),console.error(`更新回测失败: ${A.name}`,z)}m.success(`批量更新完成！成功更新 ${l} 个回测，失败 ${c} 个`),ee(),c>0&&ke.info({title:"更新结果详情",content:e.jsxs("div",{children:[e.jsxs("p",{children:["成功更新: ",l," 个"]}),e.jsxs("p",{children:["更新失败: ",c," 个"]}),j.length>0&&e.jsxs("div",{children:[e.jsx("p",{children:"失败项目:"}),e.jsx("ul",{children:j.map((A,z)=>e.jsxs("li",{children:[A.name,": ",A.error]},z))})]})]}),width:500})}catch(A){console.error("批量更新失败:",A),m.error("批量更新失败，请重试")}finally{U(!1)}})})}),le=d=>vt(void 0,null,function*(){re(!0);try{const t=yield K.get(`/api/backtest-status/${d}`);if(t.data.status==="success"){const l=t.data.data;l.results&&l.results.trades&&(l.results.trades=l.results.trades.sort((c,j)=>new Date(j.date).getTime()-new Date(c.date).getTime())),l.trade_records&&(l.trade_records=l.trade_records.sort((c,j)=>new Date(j.date).getTime()-new Date(c.date).getTime())),he(l),J(!0)}else m.error("获取回测详情失败")}catch(t){console.error("获取回测详情失败:",t),m.error("获取回测详情失败")}finally{re(!1)}}),Fe=d=>vt(void 0,null,function*(){ke.confirm({title:"确认删除",content:"此操作将永久删除该回测记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>vt(void 0,null,function*(){try{const t=yield K.delete(`/api/backtest-status/${d}`);t.data.status==="success"?(m.success("删除成功"),ee()):m.error(t.data.message||"删除失败")}catch(t){console.error("删除回测失败:",t),m.error("删除失败，请重试")}})})}),tt=d=>{Me(d),Ue.setFieldsValue({new_name:d.name,new_description:d.description||"",update_to_date:null}),Le(!0)},kt=d=>{const t=d.logs||[];G(t),O(!0)},He=()=>vt(void 0,null,function*(){var d,t,l;if(X)try{const c=yield Ue.validateFields();Ne(!0);const j={new_name:c.new_name,new_description:c.new_description||"",update_to_date:c.update_to_date?c.update_to_date.format("YYYY-MM-DD"):void 0},A=yield K.post(`/api/backtest-status/${X.id}/update`,j);if(A.data.status==="success"){m.success("回测更新成功！"),Le(!1),Ue.resetFields(),ee();const z=A.data.data;ke.success({title:"更新成功",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"新回测名称:"})," ",z.new_backtest_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"更新日期范围:"})," ",z.update_range.start_date," 至 ",z.update_range.end_date]}),z.performance_metrics&&e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"性能指标:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:["总收益率: ",(z.performance_metrics.total_return*100).toFixed(2),"%"]}),e.jsxs("li",{children:["最大回撤: ",(z.performance_metrics.max_drawdown*100).toFixed(2),"%"]}),e.jsxs("li",{children:["夏普比率: ",((d=z.performance_metrics.sharpe_ratio)==null?void 0:d.toFixed(2))||"N/A"]})]})]})]}),okText:"确定"})}else m.error(A.data.message||"更新失败")}catch(c){console.error("更新回测失败:",c),m.error(((l=(t=c.response)==null?void 0:t.data)==null?void 0:l.detail)||"更新失败，请重试")}finally{Ne(!1)}}),nt=[{title:"ID",dataIndex:"id",key:"id",width:60,fixed:"left",align:"center"},{title:"回测名称",dataIndex:"name",key:"name",width:180,fixed:"left",ellipsis:!0,render:d=>e.jsx(me,{title:d,placement:"topLeft",children:e.jsx(ct,{strong:!0,style:{color:"#1890ff"},children:d})})},{title:"策略",dataIndex:"strategy_name",key:"strategy_name",width:120,ellipsis:!0,render:d=>e.jsx(me,{title:d||"未知策略",placement:"topLeft",children:e.jsx(be,{color:"blue",children:d||"未知"})})},{title:"自定义参数",key:"parameters",width:150,ellipsis:!0,render:(d,t)=>{const l=t.parameters;if(!l||Object.keys(l).length===0)return e.jsx(ct,{style:{color:"#999"},children:"-"});const c=l.parameters||{},j=Object.keys(c).length;if(j===0)return e.jsx(ct,{style:{color:"#999"},children:"-"});const z=Object.entries(c).slice(0,2).map(([te,D])=>`${te}:${D}`).join(", "),ge=j>2?`${z}...`:z;return e.jsx(me,{title:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px"},children:"策略参数:"}),Object.entries(c).map(([te,D])=>e.jsxs("div",{style:{marginBottom:"4px"},children:[e.jsxs("span",{style:{color:"#1890ff"},children:[te,":"]})," ",String(D)]},te))]}),placement:"topLeft",children:e.jsx(ct,{style:{color:"#722ed1",fontSize:"12px"},children:ge})})}},{title:"股票",dataIndex:"instruments",key:"instruments",width:80,align:"center",render:d=>e.jsx(be,{color:"green",children:d.join(", ")})},{title:"回测期间",key:"date_range",width:160,align:"center",render:(d,t)=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:B(t.start_date).format("MM-DD")}),e.jsxs("div",{style:{color:"#999"},children:["至 ",B(t.end_date).format("MM-DD")]})]})},{title:"状态",dataIndex:"status",key:"status",width:80,align:"center",render:d=>{const l={running:{text:"运行中",color:"processing"},completed:{text:"已完成",color:"success"},failed:{text:"失败",color:"error"}}[d]||{text:d,color:"default"};return e.jsx(be,{color:l.color,children:l.text})}},{title:"年化收益率",key:"annual_return",width:100,align:"right",render:(d,t)=>{var l;const c=(l=t.performance_metrics)==null?void 0:l.annual_return;if(c!==void 0){const j=c>=0?"#ff4d4f":"#52c41a",A=c*100;return e.jsxs(ct,{style:{color:j,fontWeight:"bold"},children:[A>=0?"+":"",A.toFixed(1),"%"]})}return e.jsx(ct,{style:{color:"#999"},children:"-"})}},{title:"最大回撤",key:"max_drawdown",width:100,align:"right",render:(d,t)=>{var l;const c=(l=t.performance_metrics)==null?void 0:l.max_drawdown;if(c!==void 0){const j=Math.floor(c*100*100)/100;return e.jsxs(ct,{style:{color:"#ff4d4f",fontWeight:"bold"},children:[j.toFixed(1),"%"]})}return e.jsx(ct,{style:{color:"#999"},children:"-"})}},{title:"最近一次交易时间",key:"last_trade_time",width:160,align:"center",render:(d,t)=>{const l=t.trade_records||[];if(l.length===0)return e.jsx(ct,{style:{color:"#999"},children:"-"});const c=l[l.length-1],j=c==null?void 0:c.date,A=c==null?void 0:c.action,z=c==null?void 0:c.price;if(!j)return e.jsx(ct,{style:{color:"#999"},children:"-"});const ge=A==="BUY"?"买入":A==="SELL"?"卖出":A||"未知",te=A==="BUY"?"#ff4d4f":A==="SELL"?"#52c41a":"#999";return e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:B(j).format("MM-DD")}),e.jsx("div",{style:{color:te,fontWeight:"bold",marginTop:"2px"},children:ge}),z&&e.jsxs("div",{style:{color:"#666",fontSize:"11px",marginTop:"1px"},children:["$",parseFloat(z).toFixed(2)]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:120,align:"center",render:d=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{children:B(d).format("MM-DD")}),e.jsx("div",{style:{color:"#999"},children:B(d).format("HH:mm")})]})},{title:"操作",key:"actions",width:180,fixed:"right",render:(d,t)=>e.jsxs($e,{size:"small",children:[e.jsx(me,{title:"查看详情",children:e.jsx(M,{type:"text",icon:e.jsx(us,{}),onClick:()=>le(t.id),size:"small",style:{color:"#1890ff"}})}),e.jsx(me,{title:"历史记录",children:e.jsx(M,{type:"text",icon:e.jsx(Pt,{}),onClick:()=>a(`/backtest-history/${t.id}`),size:"small",style:{color:"#52c41a"}})}),e.jsx(me,{title:"更新数据",children:e.jsx(M,{type:"text",icon:e.jsx(Rt,{}),onClick:()=>tt(t),size:"small",style:{color:"#faad14"}})}),e.jsx(me,{title:"查看日志",children:e.jsx(M,{type:"text",icon:e.jsx(bs,{}),onClick:()=>kt(t),size:"small",style:{color:"#722ed1"}})}),e.jsx(me,{title:"删除",children:e.jsx(M,{type:"text",danger:!0,icon:e.jsx(Nt,{}),onClick:()=>Fe(t.id),size:"small"})})]})}],gt=(d,t,l)=>{if(!d||d.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const c=d.filter(L=>L&&L.date&&L.equity!==void 0&&!isNaN(Number(L.equity)));if(c.length===0)return{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};let j=[],A=[];const z=new Map;c.forEach((L,V)=>{const _e=Qe(L.date);z.set(_e,V)}),t&&t.length>0&&t.forEach(L=>{const V=Qe(L.date),_e=z.get(V);if(_e!==void 0){const ye={name:L.action==="BUY"?"买入点":"卖出点",value:c[_e].equity,xAxis:_e,yAxis:c[_e].equity,itemStyle:{color:L.action==="BUY"?"#f64034":"#00b46a"}};L.action==="BUY"?j.push(ye):A.push(ye)}});let ge=-1,te=-1,D=0,Q="",De="",fe=0,Ae=0;if(c.length>0){let L=c[0].equity,V=0,_e=0;for(let ye=1;ye<c.length;ye++)c[ye].equity>L?(L=c[ye].equity,_e=ye):(V=(L-c[ye].equity)/L*100,V>D&&(D=V,ge=_e,te=ye,Q=c[_e].date,De=c[ye].date,fe=L,Ae=c[ye].equity));console.log(`最大回撤区间索引: ${ge} - ${te}`),console.log(`最大回撤: ${D.toFixed(2)}%, 从 ${Q} 到 ${De}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(L){if(Array.isArray(L)&&L.length>0){const _e=L[0].axisValue,ye=L[0].data;for(let st=0;st<L.length;st++)if(L[st].componentType==="markArea")return`最大回撤: ${D.toFixed(2)}%<br/>
                        开始日期: ${Q}<br/>
                        最高点: ¥${fe.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${De}<br/>
                        最低点: ¥${Ae.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let Je="";for(let st=0;st<L.length;st++){const Pe=L[st];if(Pe.seriesName==="买入点"||Pe.seriesName==="卖出点"){const ot=Qe(_e),It=t.find(yt=>Qe(yt.date)===ot&&(Pe.seriesName==="买入点"&&yt.action==="BUY"||Pe.seriesName==="卖出点"&&yt.action==="SELL"));if(It){const yt=It.trigger_reason||"未记录原因";Je=`<br/><span style="color:${Pe.color}">● ${Pe.seriesName}</span>`,Je+=`<br/><span style="color:#555; font-size:12px">原因: ${yt}</span>`}else Je=`<br/><span style="color:${Pe.color}">● ${Pe.seriesName}</span>`;break}}return`${_e}<br/>策略收益: ¥${parseFloat(ye).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${Je}`}const V=L.value;return`${L.name}: ¥${parseFloat(V).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:c.map(L=>L.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:c.map(L=>L.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new Js(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...j.map(L=>({name:"买入点",coord:[L.xAxis,L.yAxis],value:L.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...A.map(L=>({name:"卖出点",coord:[L.xAxis,L.yAxis],value:L.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${D.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[ge>=0&&te>=0?[{name:"最大回撤开始",xAxis:ge,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:te,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:c.map(()=>l),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:l,label:{formatter:"初始资金: ¥"+l.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(L){return`初始资金: ¥${l.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},N=(d,t)=>{if(!t||!Array.isArray(t)||t.length===0)return console.warn(`计算MA${d}失败: 数据无效`),[];const l=[];for(let c=0;c<t.length;c++){if(c<d-1){l.push("-");continue}let j=0,A=0;for(let z=0;z<d;z++){const ge=t[c-z];if(ge&&ge.length>=4){const te=Number(ge[1]);!isNaN(te)&&te>0&&(j+=te,A++)}}A>0?l.push((j/A).toFixed(2)):l.push("-")}return l},T=(d,t)=>{var l;const c=`${((l=y==null?void 0:y.instruments)==null?void 0:l[0])||"股票"} K线图与交易信号`;if(!d||d.length===0)return{title:{text:c,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"}}};const j=d.map(D=>[D.date,D.open,D.close,D.low,D.high,D.volume]);let A=[],z=[];if(t&&t.length>0){const D=new Map;j.forEach((fe,Ae)=>{const L=Qe(fe[0]);D.set(L,Ae)}),A=t.filter(fe=>fe.action==="BUY").map(fe=>{const Ae=Qe(fe.date),L=D.get(Ae),V=fe.price||0;return L===void 0||V<=0?null:{name:"买入",value:[L,V],xAxis:L,yAxis:V,itemStyle:{color:"#f64034"}}}).filter(fe=>fe!==null),z=t.filter(fe=>fe.action==="SELL").map(fe=>{const Ae=Qe(fe.date),L=D.get(Ae),V=fe.price||0;return L===void 0||V<=0?null:{name:"卖出",value:[L,V],xAxis:L,yAxis:V,itemStyle:{color:"#00b46a"}}}).filter(fe=>fe!==null)}const ge=j.map(D=>D[0]);let te=[...A.map(D=>({name:"买入点",coord:[D.value[0],D.value[1]],value:D.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...z.map(D=>({name:"卖出点",coord:[D.value[0],D.value[1]],value:D.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...A.map(D=>{const Q=D.value[0],fe=j[Q][4]*1.1;return{name:"买入标签",coord:[D.value[0],fe],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...z.map(D=>{const Q=D.value[0],fe=j[Q][4]*1.2;return{name:"卖出标签",coord:[D.value[0],fe],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];return{title:{text:c,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(D){let Q="";if(Array.isArray(D)){const De=D[0].axisValue;Q=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${De}</div>`,D.forEach(V=>{if(V.seriesName==="K线"){if(V.value&&V.value.length>=4){const _e=Number(V.value[1])||0,ye=Number(V.value[2])||0,Je=Number(V.value[3])||0,st=Number(V.value[4])||0,Pe=ye>=_e?"#f64034":"#00b46a";Q+=`<div style="color:${Pe};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${Pe};">${_e.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${Pe};">${ye.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${Pe};">${Je.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${Pe};">${st.toFixed(2)}</span><br/>
                  </div>`}}else if(V.seriesName&&V.seriesName.startsWith("MA")&&V.value!=="-"){const ye={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[V.seriesName]||V.color;try{const Je=typeof V.value=="number"?parseFloat(V.value.toString()).toFixed(3):parseFloat(V.value||"0").toFixed(3);Q+=`<div style="color:${ye};font-weight:bold;display:inline-block;margin-right:15px;">${V.seriesName}：${Je}</div>`}catch(Je){console.warn("格式化MA值出错:",Je),Q+=`<div style="color:${ye};font-weight:bold;display:inline-block;margin-right:15px;">${V.seriesName}：0</div>`}}});const fe=Qe(De),Ae=t.find(V=>V.action==="BUY"&&Qe(V.date)===fe),L=t.find(V=>V.action==="SELL"&&Qe(V.date)===fe);if((Ae||L)&&(Q+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),Ae){const V=Ae.price||0,_e=Ae.trigger_reason||"未记录原因";Q+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${V.toFixed(2)}<br/>
                原因：${_e}
              </div>`}if(L){const V=L.price||0,_e=L.trigger_reason||"未记录原因";Q+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${V.toFixed(2)}<br/>
                原因：${_e}
              </div>`}}return Q}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:ge,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:j.map(D=>[Number(D[1]),Number(D[2]),Number(D[3]),Number(D[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:te,animation:!1,z:10}},{name:"MA5",type:"line",data:N(5,j.map(D=>[Number(D[1]),Number(D[2]),Number(D[3]),Number(D[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:N(10,j.map(D=>[Number(D[1]),Number(D[2]),Number(D[3]),Number(D[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:N(20,j.map(D=>[Number(D[1]),Number(D[2]),Number(D[3]),Number(D[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:N(30,j.map(D=>[Number(D[1]),Number(D[2]),Number(D[3]),Number(D[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}},ie=o.useMemo(()=>{var d,t,l,c;return[{key:"1",label:e.jsxs("span",{children:[e.jsx(dt,{}),"绩效分析"]}),children:e.jsx(pe,{gutter:16,children:e.jsx(b,{span:24,style:{marginBottom:16},children:e.jsx(_t,{option:gt((y==null?void 0:y.equity_curve)||[],((d=y==null?void 0:y.results)==null?void 0:d.trades)||(y==null?void 0:y.trade_records)||[],(y==null?void 0:y.initial_capital)||1e5),style:{height:500},notMerge:!0,opts:{renderer:"canvas"}},`equity-chart-${g}`)})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(dt,{}),"K线与交易信号"]}),children:e.jsx(pe,{gutter:16,children:e.jsx(b,{span:24,children:e.jsx(ce,{title:`${((t=y==null?void 0:y.instruments)==null?void 0:t[0])||"股票"}交易图表`,extra:e.jsxs($e,{children:[e.jsx(M,{type:"primary",size:"small",onClick:()=>{const j=document.querySelector(".kline-chart");if(j){const A=j.__echarts__;A&&A.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(M,{size:"small",onClick:()=>{var j;const A=((j=y==null?void 0:y.results)==null?void 0:j.trades)||(y==null?void 0:y.trade_records)||[],z=(y==null?void 0:y.equity_curve)||[];if(A.length>0&&z.length>0){const ge=new Map;z.forEach((D,Q)=>{const De=Qe(D.date);ge.set(De,Q)});const te=[];if(A.forEach(D=>{const Q=Qe(D.date),De=ge.get(Q);De!==void 0&&te.push(De)}),te.length>0){const D=Math.max(0,Math.min(...te)-10),Q=Math.min(z.length-1,Math.max(...te)+10),De=D/z.length*100,fe=Q/z.length*100,Ae=document.querySelector(".kline-chart");if(Ae){const L=Ae.__echarts__;L&&(L.dispatchAction({type:"dataZoom",start:De,end:fe}),m.success(`已聚焦到交易区域，共显示 ${te.length} 个交易点`))}}else m.info("未找到交易信号对应的K线数据点")}else m.info("没有交易记录或K线数据")},children:"聚焦交易"}),e.jsx(me,{title:"只显示有交易的区域",children:e.jsx(Ie,{})})]}),children:e.jsx(_t,{className:"kline-chart",option:T((y==null?void 0:y.equity_curve)||[],((l=y==null?void 0:y.results)==null?void 0:l.trades)||(y==null?void 0:y.trade_records)||[]),style:{height:600},notMerge:!0,opts:{renderer:"canvas"}},`kline-chart-${g}`)})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Ie,{}),"交易明细"]}),children:e.jsx(wt,{dataSource:((c=y==null?void 0:y.results)==null?void 0:c.trades)||(y==null?void 0:y.trade_records)||[],columns:Ye,rowKey:j=>`trade-${j.date}-${j.action}-${j.price}`,pagination:{pageSize:10},scroll:{x:!0}})}]},[y]);return o.useEffect(()=>{Ce.current||(Ce.current=!0,ee())},[]),o.useEffect(()=>{if(h==="all")$(u);else{const d=u.filter(t=>t.strategy_name===h);$(d)}},[u,h]),o.useEffect(()=>{if(F&&y){const d=setTimeout(()=>{C.current&&C.current.getEchartsInstance().resize(),Se.current&&Se.current.getEchartsInstance().resize(),E(l=>l+1)},500),t=()=>{C.current&&C.current.getEchartsInstance().resize(),Se.current&&Se.current.getEchartsInstance().resize()};return window.addEventListener("resize",t),()=>{clearTimeout(d),window.removeEventListener("resize",t)}}},[F,y]),e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("style",{children:`
        .table-row-light {
          background-color: #fafafa;
        }
        .table-row-dark {
          background-color: #ffffff;
        }
        .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
          font-weight: 600 !important;
          text-align: center !important;
          white-space: nowrap !important;
        }
        .ant-table-tbody > tr:hover > td {
          background-color: #e6f7ff !important;
        }
        .ant-table-tbody > tr > td {
          padding: 8px 12px !important;
          border-bottom: 1px solid #f0f0f0 !important;
        }
        .ant-table-fixed-left .ant-table-thead > tr > th,
        .ant-table-fixed-right .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
        }
        .ant-table-fixed-left .ant-table-tbody > tr > td,
        .ant-table-fixed-right .ant-table-tbody > tr > td {
          background-color: inherit !important;
        }
      `}),e.jsx(ce,{title:e.jsxs($e,{children:[e.jsx(Pt,{}),e.jsx("span",{children:"回测历史"})]}),extra:e.jsxs($e,{size:"middle",children:[e.jsx($e.Compact,{children:e.jsxs(et,{value:h,onChange:v,style:{width:180},placeholder:"选择策略筛选",allowClear:!0,size:"middle",suffixIcon:e.jsx(Ja,{}),children:[e.jsx(et.Option,{value:"all",children:"全部策略"}),Array.from(new Set(u.map(d=>d.strategy_name).filter(Boolean))).map(d=>e.jsx(et.Option,{value:d,children:d},d))]})}),e.jsx(M,{icon:e.jsx(Rt,{}),onClick:Te,loading:xe,type:"primary",children:"一键更新到最新K线"}),e.jsx(M,{icon:e.jsx(ds,{}),onClick:ee,loading:n,children:"刷新"})]}),children:e.jsx(wt,{columns:nt,dataSource:w,rowKey:"id",loading:n,size:"small",bordered:!0,pagination:{pageSize:Oe.getPageSize(15),showSizeChanger:!0,showQuickJumper:!0,showTotal:(d,t)=>`第 ${t[0]}-${t[1]} 条，共 ${d} 条`,pageSizeOptions:["10","15","20","50"],size:"small",onChange:(d,t)=>{Oe.setCurrentPage(d),Oe.setPageSize(t||15)},onShowSizeChange:(d,t)=>{Oe.setPageSize(t)}},scroll:{x:1550,y:"calc(100vh - 300px)"},rowClassName:(d,t)=>t%2===0?"table-row-light":"table-row-dark"})}),e.jsx(ke,{title:"回测详情",open:F,onCancel:()=>{J(!1),ne("performance")},footer:null,width:1200,destroyOnClose:!0,afterOpenChange:d=>{d&&setTimeout(()=>{C.current&&C.current.getEchartsInstance().resize(),Se.current&&Se.current.getEchartsInstance().resize()},100)},children:y&&e.jsxs("div",{children:[e.jsxs(Re,{title:"基本信息",bordered:!0,column:2,style:{marginBottom:24},children:[e.jsx(Re.Item,{label:"回测名称",children:y.name}),e.jsx(Re.Item,{label:"策略名称",children:((r=y.strategy_info)==null?void 0:r.name)||"-"}),e.jsxs(Re.Item,{label:"回测期间",children:[B(y.start_date).format("YYYY-MM-DD")," 至 ",B(y.end_date).format("YYYY-MM-DD")]}),e.jsxs(Re.Item,{label:"初始资金",children:["$",y.initial_capital.toLocaleString()]}),e.jsx(Re.Item,{label:"交易标的",children:y.instruments.join(", ")}),e.jsx(Re.Item,{label:"状态",children:e.jsx(be,{color:y.status==="completed"?"success":"processing",children:y.status==="completed"?"已完成":"运行中"})})]}),y.performance_metrics&&e.jsxs(ce,{title:"性能指标",style:{marginBottom:24},children:[e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(me,{title:"策略的年化收益率",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:(y.performance_metrics.annual_return||0)*100,precision:2,valueStyle:{color:(y.performance_metrics.annual_return||0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(me,{title:"策略的最大回撤幅度",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.max_drawdown*100,precision:2,valueStyle:{color:"#ff4d4f"},suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(me,{title:"风险调整后的收益指标",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.sharpe_ratio,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["胜率 ",e.jsx(me,{title:"盈利交易占总交易的比例",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.win_rate*100,precision:2,suffix:"%"})})]}),e.jsxs(pe,{gutter:16,style:{marginTop:24},children:[e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(me,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.profit_factor||0,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["Alpha ",e.jsx(me,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2,suffix:"%"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["Beta ",e.jsx(me,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2})}),e.jsx(b,{span:6,children:e.jsx(de,{title:e.jsxs("span",{children:["最近一次交易时间 ",e.jsx(me,{title:"最后一次交易的时间和方向",children:e.jsx(Ie,{style:{fontSize:14,color:"#aaa"}})})]}),value:(()=>{const d=y.trade_records||[];if(d.length===0)return"-";const t=d[d.length-1],l=t==null?void 0:t.date,c=t==null?void 0:t.action,j=t==null?void 0:t.price;if(!l)return"-";const A=c==="BUY"?"买入":c==="SELL"?"卖出":c||"未知",z=j?` @ $${parseFloat(j).toFixed(2)}`:"";return`${B(l).format("MM-DD")} (${A}${z})`})()})})]})]}),e.jsx(Tt,{defaultActiveKey:"1",items:ie})]})}),e.jsx(ke,{title:"更新回测数据",open:q,onOk:He,onCancel:()=>{Le(!1),Ue.resetFields()},confirmLoading:Ee,okText:"更新",cancelText:"取消",width:600,children:e.jsxs(H,{form:Ue,layout:"vertical",style:{marginTop:16},children:[e.jsx(H.Item,{label:"新回测名称",name:"new_name",rules:[{required:!0,message:"请输入新回测名称"}],children:e.jsx(Be,{placeholder:"请输入新回测名称"})}),e.jsx(H.Item,{label:"更新到日期",name:"update_to_date",extra:"留空则自动更新到最新可用数据（通常是昨天）",children:e.jsx(Bt,{style:{width:"100%"},placeholder:"选择更新截止日期（可选）",format:"YYYY-MM-DD"})}),e.jsx(H.Item,{label:"回测描述",name:"new_description",extra:"可选：更新回测的描述信息",children:e.jsx(Be.TextArea,{placeholder:"请输入回测描述（可选）",rows:3})}),X&&e.jsx(We,{message:"更新说明",description:e.jsxs("div",{children:[e.jsx("p",{children:"• 将基于原回测的配置（策略、参数、仓位配置等）重新运行回测"}),e.jsxs("p",{children:["• 起始日期保持原回测的起始日期：",X.start_date]}),e.jsx("p",{children:"• 结束日期将更新到您选择的日期，如不选择则自动更新到最新可用数据"}),e.jsx("p",{children:"• 将创建新的回测记录，原回测记录保持不变"})]}),type:"info",showIcon:!0,style:{marginBottom:16}})]})}),e.jsx(ke,{title:"策略执行日志",open:Ge,onCancel:()=>O(!1),footer:[e.jsx(M,{onClick:()=>O(!1),children:"关闭"},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:R.length>0?e.jsx("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:R.map((d,t)=>e.jsxs("div",{style:{marginBottom:"8px",padding:"8px 12px",backgroundColor:d.level==="ERROR"?"#fff2f0":d.level==="WARNING"?"#fffbe6":d.level==="DEBUG"?"#f6ffed":"#fafafa",border:`1px solid ${d.level==="ERROR"?"#ffccc7":d.level==="WARNING"?"#ffe58f":d.level==="DEBUG"?"#d9f7be":"#d9d9d9"}`,borderRadius:"4px"},children:[e.jsxs("div",{style:{color:d.level==="ERROR"?"#cf1322":d.level==="WARNING"?"#d46b08":d.level==="DEBUG"?"#52c41a":"#595959",fontWeight:"bold",marginBottom:"4px"},children:["[",d.timestamp,"] ",d.level]}),e.jsx("div",{style:{color:"#262626",whiteSpace:"pre-wrap"},children:d.message})]},t))}):e.jsxs("div",{style:{textAlign:"center",color:"#999",padding:"40px 0"},children:[e.jsx(bs,{style:{fontSize:"48px",marginBottom:"16px"}}),e.jsx("div",{children:"暂无策略执行日志"}),e.jsx("div",{style:{fontSize:"12px",marginTop:"8px"},children:"策略中可以使用 log() 函数记录执行过程"})]})})})]})});var Xt=(r,a,n)=>new Promise((f,u)=>{var x=h=>{try{$(n.next(h))}catch(v){u(v)}},w=h=>{try{$(n.throw(h))}catch(v){u(v)}},$=h=>h.done?f(h.value):Promise.resolve(h.value).then(x,w);$((n=n.apply(r,a)).next())});ts([ss,as,rs,ns,os,ls,is,cs]);const{Title:Bs,Text:fn}=xt,xn=()=>{const{id:r}=Vs(),a=St(),[n,f]=o.useState(!1),[u,x]=o.useState(null),[w,$]=o.useState([]),[h,v]=o.useState(!1),[F,J]=o.useState(null),[y,he]=o.useState(!1),ve=()=>Xt(void 0,null,function*(){if(r){f(!0);try{const g=yield K.get(`/api/backtest-status/${r}`);g.data.status==="success"?x(g.data.data):m.error("获取回测状态失败")}catch(g){console.error("获取回测状态失败:",g),m.error("获取回测状态失败")}finally{f(!1)}}}),re=()=>Xt(void 0,null,function*(){if(r){f(!0);try{const g=yield K.get(`/api/backtest-status/${r}/history`);$(g.data)}catch(g){console.error("获取回测历史失败:",g),m.error("获取回测历史失败")}finally{f(!1)}}}),W=g=>Xt(void 0,null,function*(){he(!0);try{const E=w.find(C=>C.id===g);E&&(J(E),v(!0))}catch(E){console.error("获取历史记录详情失败:",E),m.error("获取历史记录详情失败")}finally{he(!1)}}),ne=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"回测期间",key:"period",render:(g,E)=>e.jsxs("div",{children:[e.jsx("div",{children:B(E.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#666",fontSize:"12px"},children:["至 ",B(E.end_date).format("YYYY-MM-DD")]})]})},{title:"初始资金",dataIndex:"initial_capital",key:"initial_capital",render:g=>`$${g.toLocaleString()}`},{title:"状态",dataIndex:"status",key:"status",render:g=>e.jsx(be,{color:g==="completed"?"green":g==="running"?"blue":"red",children:g==="completed"?"已完成":g==="running"?"运行中":"失败"})},{title:"收益率",dataIndex:"total_return",key:"total_return",render:g=>e.jsxs("span",{style:{color:g>=0?"#52c41a":"#ff4d4f"},children:[g>=0?"+":"",g.toFixed(2),"%"]})},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:g=>e.jsxs("span",{style:{color:"#ff4d4f"},children:[g.toFixed(2),"%"]})},{title:"操作类型",dataIndex:"operation_type",key:"operation_type",render:g=>e.jsx(be,{color:g==="create"?"blue":"orange",children:g==="create"?"创建":g==="update"?"更新":"重新运行"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:g=>B(g).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(g,E)=>e.jsx($e,{children:e.jsx(M,{type:"link",icon:e.jsx(us,{}),onClick:()=>W(E.id),loading:y,children:"查看"})})}];return o.useEffect(()=>{ve(),re()},[r]),u?e.jsxs("div",{style:{padding:"24px"},children:[e.jsx(ce,{style:{marginBottom:"16px"},children:e.jsxs($e,{children:[e.jsx(M,{icon:e.jsx(Xs,{}),onClick:()=>a("/backtest/history"),children:"返回列表"}),e.jsxs(Bs,{level:3,style:{margin:0},children:[e.jsx(Pt,{})," ",u.name," - 历史记录"]})]})}),e.jsx(ce,{title:"当前状态概览",style:{marginBottom:"16px"},children:e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:6,children:e.jsx(de,{title:"策略名称",value:u.strategy_name||"未知"})}),e.jsx(b,{span:6,children:e.jsx(de,{title:"回测期间",value:`${B(u.start_date).format("YYYY-MM-DD")} 至 ${B(u.end_date).format("YYYY-MM-DD")}`})}),e.jsx(b,{span:6,children:e.jsx(de,{title:"初始资金",value:`$${u.initial_capital.toLocaleString()}`})}),e.jsx(b,{span:6,children:e.jsx(de,{title:"当前收益率",value:u.total_return,precision:2,suffix:"%",valueStyle:{color:u.total_return>=0?"#52c41a":"#ff4d4f"}})})]})}),e.jsx(ce,{title:e.jsxs($e,{children:[e.jsx(Pt,{}),e.jsx("span",{children:"历史记录"})]}),extra:e.jsx(M,{icon:e.jsx(ds,{}),onClick:re,loading:n,children:"刷新"}),children:e.jsx(Ws,{columns:ne,dataSource:w,rowKey:"id",loading:n,pagination:{pageSize:Oe.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:(g,E)=>`第 ${E[0]}-${E[1]} 条，共 ${g} 条`,onChange:(g,E)=>{Oe.setCurrentPage(g),Oe.setPageSize(E||20)},onShowSizeChange:(g,E)=>{Oe.setPageSize(E)}},scroll:{x:1200}})}),e.jsx(ke,{title:"历史记录详情",open:h,onCancel:()=>v(!1),footer:[e.jsx(M,{onClick:()=>v(!1),children:"关闭"},"close")],width:800,children:F&&e.jsxs("div",{children:[e.jsxs(Re,{bordered:!0,column:2,children:[e.jsx(Re.Item,{label:"记录ID",children:F.id}),e.jsx(Re.Item,{label:"操作类型",children:e.jsx(be,{color:F.operation_type==="create"?"blue":"orange",children:F.operation_type==="create"?"创建":"更新"})}),e.jsxs(Re.Item,{label:"回测期间",span:2,children:[B(F.start_date).format("YYYY-MM-DD")," 至 ",B(F.end_date).format("YYYY-MM-DD")]}),e.jsxs(Re.Item,{label:"初始资金",children:["$",F.initial_capital.toLocaleString()]}),e.jsx(Re.Item,{label:"状态",children:e.jsx(be,{color:F.status==="completed"?"green":"red",children:F.status==="completed"?"已完成":"失败"})}),e.jsx(Re.Item,{label:"收益率",children:e.jsxs("span",{style:{color:F.total_return>=0?"#52c41a":"#ff4d4f"},children:[F.total_return>=0?"+":"",F.total_return.toFixed(2),"%"]})}),e.jsx(Re.Item,{label:"最大回撤",children:e.jsxs("span",{style:{color:"#ff4d4f"},children:[F.max_drawdown.toFixed(2),"%"]})}),e.jsx(Re.Item,{label:"创建时间",children:B(F.created_at).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(Re.Item,{label:"完成时间",children:F.completed_at?B(F.completed_at).format("YYYY-MM-DD HH:mm:ss"):"未完成"})]}),F.performance_metrics&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Bs,{level:5,children:"性能指标"}),e.jsxs(pe,{gutter:16,children:[e.jsx(b,{span:8,children:e.jsx(de,{title:"夏普比率",value:F.performance_metrics.sharpe_ratio||0,precision:3})}),e.jsx(b,{span:8,children:e.jsx(de,{title:"波动率",value:F.performance_metrics.volatility||0,precision:2,suffix:"%"})}),e.jsx(b,{span:8,children:e.jsx(de,{title:"胜率",value:F.performance_metrics.win_rate||0,precision:2,suffix:"%"})})]})]})]})})]}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(ce,{loading:n,children:e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(fn,{children:"加载中..."})})})})};const{Content:gn}=zt,yn=()=>e.jsx(ea,{locale:ta,theme:sa,children:e.jsx(Qa,{children:e.jsx($a,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(zt,{style:{minHeight:"100vh"},children:[e.jsx(sr,{}),e.jsxs(zt,{children:[e.jsx(rr,{}),e.jsx(zt,{style:{padding:"24px"},children:e.jsx(gn,{style:{padding:24,margin:0,minHeight:280,background:"#fff",borderRadius:"8px"},children:e.jsxs(Da,{children:[e.jsx(at,{path:"/",element:e.jsx(za,{to:"/dashboard",replace:!0})}),e.jsx(at,{path:"/dashboard",element:e.jsx(hr,{})}),e.jsx(at,{path:"/data",element:e.jsx(la,{})}),e.jsx(at,{path:"/strategy",element:e.jsx(un,{})}),e.jsx(at,{path:"/strategy/edit",element:e.jsx(Rs,{})}),e.jsx(at,{path:"/strategy/edit/:id",element:e.jsx(Rs,{})}),e.jsx(at,{path:"/strategy/builder",element:e.jsx(Tr,{})}),e.jsx(at,{path:"/backtest",element:e.jsx(en,{})}),e.jsx(at,{path:"/backtest/history",element:e.jsx(mn,{})}),e.jsx(at,{path:"/backtest-history/:id",element:e.jsx(xn,{})}),e.jsx(at,{path:"/optimization",element:e.jsx(cn,{})})]})})})]})]})})})});Gs.locale("en-gb");K.defaults.baseURL="http://localhost:8001";Ca.createRoot(document.getElementById("root")).render(e.jsx(Ia.StrictMode,{children:e.jsx(ea,{locale:ta,theme:sa,children:e.jsx(yn,{})})}));
