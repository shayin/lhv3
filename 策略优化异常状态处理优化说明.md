# 策略优化异常状态处理优化说明

## 问题背景

在策略参数优化过程中，如果优化任务因为网络中断、服务器重启或其他原因导致任务中断，任务状态会一直显示为"运行中"，但实际上已经无法继续执行。这种情况下，用户无法删除这些"僵尸"任务，导致界面混乱。

## 优化方案

### 1. 异常状态检测
通过时间判断来识别异常状态：
- **检测条件**：任务状态为"运行中"且创建时间超过1小时
- **判断逻辑**：`record.status === 'running' && dayjs().diff(dayjs(record.created_at), 'hour') >= 1`

### 2. 操作权限调整
- **正常状态**：运行中的任务不允许删除
- **异常状态**：允许强制删除，并显示特殊提示

## 技术实现

### 1. 异常状态判断
```typescript
// 判断是否为异常状态：运行中但创建时间超过1小时
const isAbnormal = record.status === 'running' && 
  dayjs().diff(dayjs(record.created_at), 'hour') >= 1;
```

### 2. 删除按钮逻辑
```typescript
<Button 
  danger
  size="small"
  disabled={record.status === 'running' && !isAbnormal}
  icon={<DeleteOutlined />}
  style={{ 
    padding: '2px 8px', 
    height: 'auto', 
    fontSize: '12px',
    ...(isAbnormal && { borderColor: '#ff7875', color: '#ff7875' })
  }}
>
  {isAbnormal ? '强制删除' : '删除'}
</Button>
```

### 3. 确认对话框优化
```typescript
<Popconfirm
  title="确认删除"
  description={
    isAbnormal 
      ? `检测到异常状态，确定要删除优化任务 "${record.name}" 吗？此操作不可恢复。`
      : `确定要删除优化任务 "${record.name}" 吗？此操作不可恢复。`
  }
  onConfirm={() => handleDeleteJob(record)}
  okText="确定"
  cancelText="取消"
  disabled={record.status === 'running' && !isAbnormal}
  placement="top"
>
```

## 功能特点

### 1. 智能检测
- **时间阈值**：1小时作为异常判断标准
- **状态结合**：只有"运行中"状态才进行时间判断
- **自动识别**：无需用户手动标记异常状态

### 2. 视觉区分
- **按钮文本**：异常状态显示"强制删除"
- **按钮样式**：异常状态使用特殊颜色（#ff7875）
- **提示信息**：异常状态显示特殊的确认提示

### 3. 用户体验
- **操作权限**：异常状态允许删除操作
- **安全提示**：明确告知用户这是异常状态
- **操作确认**：双重确认防止误操作

## 使用场景

### 1. 正常情况
- 任务正常运行：删除按钮禁用
- 任务已完成：可以正常查看和删除

### 2. 异常情况
- 任务中断超过1小时：显示"强制删除"按钮
- 按钮颜色变化：提醒用户这是异常状态
- 特殊提示：确认对话框说明这是异常状态

## 配置参数

### 时间阈值设置
```typescript
// 当前设置为1小时，可以根据需要调整
const isAbnormal = record.status === 'running' && 
  dayjs().diff(dayjs(record.created_at), 'hour') >= 1;
```

### 可调整参数
- **时间阈值**：可以修改为30分钟、2小时等
- **判断条件**：可以添加其他判断条件（如进度长时间不变）
- **视觉样式**：可以调整异常状态的显示样式

## 扩展性

### 1. 更复杂的异常检测
```typescript
// 可以添加更多判断条件
const isAbnormal = record.status === 'running' && (
  dayjs().diff(dayjs(record.created_at), 'hour') >= 1 || // 时间超时
  (record.progress > 0 && dayjs().diff(dayjs(record.updated_at), 'minute') >= 30) // 进度停滞
);
```

### 2. 批量处理
```typescript
// 可以添加批量删除异常任务的功能
const handleBatchDeleteAbnormal = () => {
  const abnormalJobs = optimizationJobs.filter(job => 
    job.status === 'running' && 
    dayjs().diff(dayjs(job.created_at), 'hour') >= 1
  );
  // 批量删除逻辑
};
```

## 总结

这次优化解决了策略优化任务异常中断后无法清理的问题，通过智能的时间判断和视觉区分，让用户能够识别并处理异常状态的任务，提升了系统的可用性和用户体验。

主要改进：
1. ✅ **智能检测**：自动识别异常状态
2. ✅ **操作权限**：异常状态允许删除
3. ✅ **视觉区分**：异常状态特殊显示
4. ✅ **用户提示**：明确告知异常状态
5. ✅ **安全确认**：防止误操作
